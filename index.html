<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>나만의 여행 플래너</title>
<script src="https://cdn.tailwindcss.com"></script>

<style>
.no-scrollbar::-webkit-scrollbar { display: none; }
.no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
#overview-map-container, #day-map { width:100%; height:100%; }
</style>
</head>

<body class="bg-gray-50 text-gray-800" id="app-container">
<div class="flex h-screen items-center justify-center text-teal-600 font-bold">플래너 로딩 중...</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

/* ================== 설정 ================== */
const GOOGLE_MAPS_API_KEY = "AIzaSyBwZ1hfLte8a0KcT9V2Tht3da_gi2tC4Rw";

const FIREBASE_CONFIG = {
  apiKey: "AIzaSyD1PRo3wCE4qVfb2oecjCpz0zUS4LskG8U",
  authDomain: "heroic-bonbon-481116-b5.firebaseapp.com",
  projectId: "heroic-bonbon-481116-b5",
  storageBucket: "heroic-bonbon-481116-b5.firebasestorage.app",
  messagingSenderId: "369088279206",
  appId: "1:369088279206:web:197df9cc38895a2e7afa67"
};

const appId = "my-travel-planner-v1";

/* ================== Firebase ================== */
const app = initializeApp(FIREBASE_CONFIG);
const db = getFirestore(app);
const auth = getAuth(app);

/* ================== 상태 ================== */
let state = {
  userId: null,
  isAuthReady: false,
  isMapLoaded: false,
  activeTab: "overview",
  selectedDayIndex: 0,
  data: null
};

const initialData = {
  destination: "제주도",
  startDate: "",
  endDate: "",
  schedule: [{ day:1, date:"", events:[] }],
  packingList: [],
  souvenirs: [],
  expenses: []
};

/* ================== 인증 (UID 고정) ================== */
async function authenticate(){
  let savedUid = localStorage.getItem("planner_uid");
  if(savedUid){
    state.userId = savedUid;
    state.isAuthReady = true;
    startFirestore();
    render();
    return;
  }
  const result = await signInAnonymously(auth);
  localStorage.setItem("planner_uid", result.user.uid);
  state.userId = result.user.uid;
  state.isAuthReady = true;
  startFirestore();
  render();
}

/* ================== Firestore ================== */
function startFirestore(){
  const ref = doc(db,"artifacts",appId,"users",state.userId,"plans","planData");
  onSnapshot(ref,snap=>{
    if(snap.exists()){
      state.data = snap.data();
    }else{
      state.data = initialData;
      setDoc(ref, initialData);
    }
    render();
    if(state.activeTab==="overview") initOverviewMap();
    if(state.activeTab==="schedule") initDayMap();
  });
}

function saveData(){
  const ref = doc(db,"artifacts",appId,"users",state.userId,"plans","planData");
  setDoc(ref, state.data);
}

/* ================== Google Maps ================== */
window.onGoogleMapLoaded = () => {
  state.isMapLoaded = true;
  render();
};

function loadMapScript(){
  const s = document.createElement("script");
  s.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&libraries=places&callback=onGoogleMapLoaded`;
  s.async = true;
  document.head.appendChild(s);
}

let overviewMap, dayMap;

function initOverviewMap(){
  const el = document.getElementById("overview-map-container");
  if(!el || !state.isMapLoaded) return;
  if(!overviewMap){
    overviewMap = new google.maps.Map(el,{
      center:{lat:33.3846,lng:126.5535},
      zoom:10
    });
  }
  overviewMapMarkers();
}

function overviewMapMarkers(){
  if(!overviewMap) return;
  state.data.schedule.forEach(day=>{
    day.events.forEach(e=>{
      if(e.lat && e.lng){
        new google.maps.Marker({
          map:overviewMap,
          position:{lat:e.lat,lng:e.lng}
        });
      }
    });
  });
}

function initDayMap(){
  const el = document.getElementById("day-map");
  if(!el || !state.isMapLoaded) return;
  dayMap = new google.maps.Map(el,{
    zoom:13,
    center:{lat:33.3846,lng:126.5535}
  });
  const day = state.data.schedule[state.selectedDayIndex];
  day.events.forEach(e=>{
    if(e.lat && e.lng){
      new google.maps.Marker({
        map:dayMap,
        position:{lat:e.lat,lng:e.lng}
      });
    }
  });
}

/* ================== 렌더 ================== */
function render(){
  if(!state.isAuthReady || !state.data){
    document.getElementById("app-container").innerHTML = "로딩 중...";
    return;
  }

  document.getElementById("app-container").innerHTML = `
  <div class="p-4 max-w-4xl mx-auto">
    <div class="flex gap-2 mb-4">
      <button onclick="setTab('overview')">여행 개요</button>
      <button onclick="setTab('schedule')">일정표</button>
    </div>

    ${state.activeTab==="overview"?`
      <div class="h-96 border rounded">
        <div id="overview-map-container"></div>
      </div>
    `:""}

    ${state.activeTab==="schedule"?`
      <div class="h-64 border rounded mt-4">
        <div id="day-map"></div>
      </div>
    `:""}
  </div>
  `;

  requestAnimationFrame(()=>{
    if(state.activeTab==="overview") initOverviewMap();
    if(state.activeTab==="schedule") initDayMap();
  });
}

window.setTab = (t)=>{ state.activeTab=t; render(); };

document.addEventListener("DOMContentLoaded",()=>{
  loadMapScript();
  authenticate();
});
</script>
</body>
</html>
