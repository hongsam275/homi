<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>여행 플래너</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
.no-scrollbar::-webkit-scrollbar{display:none}.no-scrollbar{-ms-overflow-style:none;scrollbar-width:none}
@keyframes f{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}.a-f{animation:f 0.5s ease-out}
</style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">
<div id="loading" class="flex h-screen items-center justify-center text-teal-600 font-bold">로딩 중...</div>
<div id="app" class="hidden min-h-screen pb-20">
  <!-- Header -->
  <header class="bg-teal-600 text-white p-4 shadow-md sticky top-0 z-20 flex justify-between items-center">
    <h1 class="text-lg font-bold flex items-center gap-2"><span id="icon-map-h"></span>여행 플래너</h1>
    <button onclick="st.modal=true;r()" class="text-xs bg-teal-700 px-3 py-1 rounded flex gap-1 items-center">초기화</button>
  </header>
  <!-- Content -->
  <div class="max-w-4xl mx-auto p-4">
    <!-- Tabs -->
    <div class="flex gap-1 mb-6 bg-white p-2 rounded-lg shadow overflow-x-auto justify-between" id="tabs"></div>
    <!-- Views -->
    <div id="view-content"></div>
  </div>
  <!-- Modal -->
  <div id="modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
      <h3 class="font-bold mb-4">⚠️ 데이터 초기화</h3>
      <p class="text-sm text-gray-600 mb-6">모든 데이터가 삭제됩니다.</p>
      <div class="flex justify-end gap-2">
        <button onclick="st.modal=false;r()" class="px-4 py-2 bg-gray-200 rounded text-sm">취소</button>
        <button onclick="resetData()" class="px-4 py-2 bg-red-600 text-white rounded text-sm">확인</button>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// ==========================================
// [필수 수정 1] 구글 맵 API 키 (Places API 포함)
const MAP_KEY = 'AlzaSyBwZ1hfLte8a0KcT9V2Tht3da_gi2tC4Rw'; 

// [필수 수정 2] Firebase 프로젝트 설정값 (Firebase Console -> 프로젝트 설정 -> 일반 -> 내 앱 -> SDK 설정 및 구성)
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyD1PRo3wCE4qVfb2oecjCpz0zUS4LskG8U",
  authDomain: "heroic-bonbon-481116-b5.firebaseapp.com",
  projectId: "heroic-bonbon-481116-b5",
  storageBucket: "heroic-bonbon-481116-b5.firebasestorage.app",
  messagingSenderId: "369088279206",
  appId: "1:369088279206:web:197df9cc38895a2e7afa67",
  measurementId: "G-8CP3MWTD7R"
};
// ==========================================

let db, auth, uid;
const I={Map:'<path d="M3 6l6-3 6 3 6-3v15l-6 3-6-3-6 3z"/><path d="M9 3v15"/><path d="M15 6v15"/>',Cal:'<rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4"/><path d="M8 2v4"/><path d="M3 10h18"/>',Check:'<polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>',Gift:'<rect x="3" y="8" width="18" height="4" rx="1"/><path d="M12 8v13"/><path d="M19 12v6"/><path d="M5 12v6"/><path d="M12 22H5"/><path d="M12 22h7"/>',Dol:'<line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>',Plus:'<path d="M12 5v14"/><path d="M5 12h14"/>',Trash:'<path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M15 2h-6l-1 4h8z"/>',Pin:'<path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/>'};
const svg=(p,c='currentColor')=>`<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="${c}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">${p}</svg>`;

// State
window.st = { tab:'overview', d:null, dayIdx:0, map:false, comp:false, modal:false,
  inp:{ dest:'', sDate:'', eDate:'', pack:'', sItem:'', sTo:'', exCat:'식비', exItem:'', exCost:'', exDate:'', evTime:'09:00', evTit:'', evPl:'', evLat:null, evLng:null }
};
const initD = { destination:'제주도', startDate:'', endDate:'', packingList:[], schedule:[{id:1, day:1, date:'', events:[]}], souvenirs:[], expenses:[] };

// Core Logic
async function init(){
  try{
    const app=initializeApp(FIREBASE_CONFIG); db=getFirestore(app); auth=getAuth(app);
    onAuthStateChanged(auth, u=>{ if(u){ uid=u.uid; loadDB(); } else signInAnonymously(auth); });
    loadMap();
  }catch(e){ alert("Firebase 설정 오류: 코드를 확인하세요."); }
}
function loadDB(){
  onSnapshot(doc(db,'plans',uid), s=>{
    if(s.exists()){ 
      st.d = s.data();
      st.inp.dest = st.d.destination; st.inp.sDate=st.d.startDate; st.inp.eDate=st.d.endDate;
    } else saveDB(initD);
    document.getElementById('loading').classList.add('hidden');
    document.getElementById('app').classList.remove('hidden');
    r();
    if(st.tab==='overview' && st.map) updateMap();
  });
}
async function saveDB(d){ if(!uid)return; try{ await setDoc(doc(db,'plans',uid), JSON.parse(JSON.stringify(d))); }catch(e){} }
window.resetData = ()=>{ saveDB(initD); st.modal=false; st.inp={...st.inp, dest:'제주도', sDate:'', eDate:''}; r(); };

// Input Handlers (Stability)
window.hIn = (k,v) => { st.inp[k]=v; if(k.includes('Cost')) r(); }; // Re-render only for formatted fields
window.hCompS = () => st.comp=true;
window.hCompE = (el,k,isOv=false) => { 
  st.comp=false; 
  if(isOv){ st.inp[k]=el.value; if(st.d) saveDB({...st.d, [k]:el.value}); }
  else { st.inp[k]=el.value; }
};
window.commitOv = (k) => { if(!st.comp && st.d && st.d[k]!==st.inp[k]) saveDB({...st.d, [k]:st.inp[k]}); };

// Actions
window.act = (type, p1, p2) => {
  const d = st.d; if(!d) return;
  if(type==='addDay'){ d.schedule.push({id:Date.now(), day:d.schedule.length+1, date:'', events:[]}); st.dayIdx=d.schedule.length-1; }
  if(type==='delDay' && d.schedule.length>1){ d.schedule.splice(p1,1); d.schedule.forEach((x,i)=>x.day=i+1); st.dayIdx=Math.max(0,p1-1); }
  if(type==='uDayDate') d.schedule[st.dayIdx].date = p1;
  
  if(type==='addEv'){
    if(!st.inp.evTit) return;
    d.schedule[st.dayIdx].events.push({id:Date.now(), time:st.inp.evTime, title:st.inp.evTit, place:st.inp.evPl||'', lat:st.inp.evLat, lng:st.inp.evLng});
    d.schedule[st.dayIdx].events.sort((a,b)=>a.time.localeCompare(b.time));
    st.inp.evTit=''; st.inp.evPl=''; st.inp.evLat=null; st.inp.evLng=null;
    if(document.getElementById('ac-in')) document.getElementById('ac-in').value='';
  }
  if(type==='delEv') d.schedule[st.dayIdx].events.splice(p1,1);
  
  if(type==='addPack'){ if(!st.inp.pack)return; d.packingList.push({id:Date.now(), text:st.inp.pack, checked:false}); st.inp.pack=''; r(); setTimeout(()=>document.getElementById('pk-in').focus(),10); }
  if(type==='togPack') d.packingList.find(x=>x.id===p1).checked = !d.packingList.find(x=>x.id===p1).checked;
  if(type==='delPack') d.packingList = d.packingList.filter(x=>x.id!==p1);

  if(type==='addSouv'){ if(!st.inp.sItem)return; d.souvenirs.push({id:Date.now(), item:st.inp.sItem, receiver:st.inp.sTo, bought:false}); st.inp.sItem=''; st.inp.sTo=''; r(); setTimeout(()=>document.getElementById('sv-in').focus(),10); }
  if(type==='togSouv') d.souvenirs.find(x=>x.id===p1).bought = !d.souvenirs.find(x=>x.id===p1).bought;
  if(type==='delSouv') d.souvenirs = d.souvenirs.filter(x=>x.id!==p1);

  if(type==='addExp'){ 
    const c = parseInt(st.inp.exCost.replace(/,/g,'')); if(!st.inp.exItem||isNaN(c))return; 
    d.expenses.push({id:Date.now(), cat:st.inp.exCat, item:st.inp.exItem, cost:c, date:st.inp.exDate}); 
    st.inp.exItem=''; st.inp.exCost=''; r(); setTimeout(()=>document.getElementById('ep-in').focus(),10);
  }
  if(type==='delExp') d.expenses = d.expenses.filter(x=>x.id!==p1);

  saveDB(d);
};

// Map
let gMap, gMark;
function loadMap(){
  if(!MAP_KEY || MAP_KEY.length<5) return;
  const s=document.createElement('script'); s.src=`https://maps.googleapis.com/maps/api/js?key=${MAP_KEY}&libraries=places`; 
  s.onload=()=>{ st.map=true; r(); }; document.head.appendChild(s);
}
// [문제 1 해결] 여행지 검색 및 지도 이동 로직 추가
window.geoCode = (addr) => {
    if(!st.map || !addr || !window.google) return;
    const geocoder = new google.maps.Geocoder();
    geocoder.geocode({ 'address': addr }, (res, status) => {
        if(status === 'OK' && gMap) {
            gMap.setCenter(res[0].geometry.location);
            gMap.setZoom(10);
            if(gMark) gMark.setMap(null);
            gMark = new google.maps.Marker({ map: gMap, position: res[0].geometry.location });
        }
    });
};
function updateMap(){
  if(!document.getElementById('map') || !window.google) return;
  if(!gMap) gMap = new google.maps.Map(document.getElementById('map'), { center:{lat:33.38, lng:126.55}, zoom:10 });
  
  // 개요 탭이면 여행지 위치로 이동
  if(st.tab === 'overview' && st.inp.dest) {
     window.geoCode(st.inp.dest);
  }

  // 핀 찍기 (일정 기반)
  if(st.d && st.d.schedule) {
      st.d.schedule.forEach((d,i)=>{
        const c=['red','blue','green','yellow'][i%4];
        d.events?.forEach(e=>{
          if(e.lat && e.lng) new google.maps.Marker({ position:{lat:e.lat,lng:e.lng}, map:gMap, icon:`http://maps.google.com/mapfiles/ms/icons/${c}-dot.png`, title:e.title });
        });
      });
  }
}
function initAC(){
  if(!st.map || !document.getElementById('ac-in')) return;
  const ac = new google.maps.places.Autocomplete(document.getElementById('ac-in'));
  ac.addListener('place_changed', ()=>{
    const p = ac.getPlace();
    if(p.geometry){ window.hIn('evPl',p.name); window.hIn('evLat',p.geometry.location.lat()); window.hIn('evLng',p.geometry.location.lng()); }
  });
}

// Render
window.r = () => {
  const t = document.getElementById('tabs');
  t.innerHTML = [['overview','개요',I.Map],['schedule','일정',I.Cal],['packing','준비',I.Check],['souvenir','기념',I.Gift],['expense','지출',I.Dol]]
    .map(([k,l,i])=>`<button onclick="st.tab='${k}';r()" class="flex-1 py-2 text-sm rounded ${st.tab===k?'bg-teal-100 text-teal-700 font-bold':'text-gray-500'} flex flex-col items-center gap-1">${svg(i)} ${l}</button>`).join('');

  const c = document.getElementById('view-content');
  const d = st.d || initD;

  if(st.tab === 'overview'){
     const total = d.expenses.reduce((s,x)=>s+x.cost,0);
     c.innerHTML = `
       <div class="space-y-4 a-f">
         <div class="grid grid-cols-2 gap-4">
           <div class="col-span-1">
             <label class="text-xs text-gray-500">여행지</label>
             <input type="text" value="${st.inp.dest}" oninput="hIn('dest',this.value)" onblur="commitOv('destination');geoCode(this.value)" oncompositionstart="hCompS()" oncompositionend="hCompE(this,'destination',true);geoCode(this.value)" class="w-full border p-2 rounded outline-none ring-teal-500 focus:ring-2">
           </div>
           <div class="col-span-1 bg-red-50 p-2 rounded text-center">
             <div class="text-xs text-red-500">총 지출</div><div class="font-bold text-red-700">${total.toLocaleString()}원</div>
           </div>
           <input type="date" value="${st.inp.sDate}" onchange="commitOv('startDate',this.value)" class="border p-2 rounded">
           <input type="date" value="${st.inp.eDate}" onchange="commitOv('endDate',this.value)" class="border p-2 rounded">
         </div>
         <div id="map" class="w-full h-80 bg-gray-200 rounded">${!st.map?'지도 로딩 실패 (API키 확인)':''}</div>
       </div>`;
     setTimeout(updateMap, 100);
  }
  else if(st.tab === 'schedule'){
    const day = d.schedule[st.dayIdx];
    c.innerHTML = `
      <div class="space-y-4 a-f">
        <div class="flex gap-2 overflow-x-auto pb-1 no-scrollbar">
          ${d.schedule.map((x,i)=>`<button onclick="st.dayIdx=${i};r()" class="px-3 py-1 rounded border whitespace-nowrap ${st.dayIdx===i?'bg-teal-600 text-white':'bg-white'}">D${x.day} ${i>0?`<span onclick="event.stopPropagation();act('delDay',${i})" class="ml-1 opacity-50">x</span>`:''}</button>`).join('')}
          <button onclick="act('addDay')" class="px-3 border rounded bg-gray-100">+</button>
        </div>
        <div class="bg-white p-4 rounded shadow border">
          <div class="flex justify-between mb-3"><h3 class="font-bold text-teal-700">Day ${day.day}</h3><input type="date" value="${day.date}" onchange="act('uDayDate',this.value)" class="border rounded p-1 text-sm"></div>
          <div class="grid grid-cols-[auto_1fr_1fr_auto] gap-2 mb-4 items-center">
            <input type="time" value="${st.inp.evTime}" onchange="hIn('evTime',this.value)" class="border p-1 rounded w-20">
            <input type="text" placeholder="일정명" value="${st.inp.evTit}" oninput="hIn('evTit',this.value)" oncompositionstart="hCompS()" oncompositionend="hCompE(this,'evTit')" class="border p-1 rounded w-full">
            <input type="text" id="ac-in" placeholder="장소검색" class="border p-1 rounded w-full">
            <button type="button" onclick="act('addEv')" class="bg-teal-600 text-white p-1 rounded w-8 h-8 flex items-center justify-center">${svg(I.Plus)}</button>
          </div>
          <div class="space-y-2 relative pl-4 border-l">
            ${day.events.map((e,i)=>`<div class="relative pl-4"><div class="absolute -left-[21px] top-1 w-3 h-3 bg-teal-500 rounded-full border-2 border-white"></div><div class="text-sm font-bold">${e.time} <span class="font-normal">${e.title}</span></div><div class="text-xs text-gray-500 flex justify-between">${e.place}<button onclick="act('delEv',${i})" class="text-red-300">x</button></div></div>`).join('')}
          </div>
        </div>
      </div>`;
    setTimeout(initAC, 100);
  }
  else if(st.tab === 'packing'){
    c.innerHTML = `
      <div class="space-y-4 a-f"><h3 class="font-bold border-b pb-1">준비물</h3>
        <div class="flex gap-2"><input id="pk-in" type="text" placeholder="입력..." value="${st.inp.pack}" oninput="hIn('pack',this.value)" onkeypress="if(event.key==='Enter')act('addPack')" oncompositionstart="hCompS()" oncompositionend="hCompE(this,'pack')" class="border p-2 rounded flex-1"><button type="button" onclick="act('addPack')" class="bg-teal-600 text-white px-4 rounded">추가</button></div>
        <div class="grid grid-cols-2 gap-2">${d.packingList.map(x=>`<div onclick="act('togPack',${x.id})" class="p-2 border rounded flex justify-between items-center bg-white cursor-pointer ${x.checked?'opacity-50':''}"><span class="flex items-center gap-2">${x.checked?svg(I.Check,'teal'):'<div class="w-4 h-4 border rounded"></div>'} ${x.text}</span><button onclick="event.stopPropagation();act('delPack',${x.id})" class="text-gray-300 hover:text-red-500">x</button></div>`).join('')}</div>
      </div>`;
  }
  else if(st.tab === 'souvenir'){
    c.innerHTML = `
      <div class="space-y-4 a-f"><h3 class="font-bold border-b pb-1">기념품</h3>
        <div class="flex gap-2"><input id="sv-in" placeholder="상품" value="${st.inp.sItem}" oninput="hIn('sItem',this.value)" oncompositionstart="hCompS()" oncompositionend="hCompE(this,'sItem')" class="border p-2 rounded flex-1"><input placeholder="대상" value="${st.inp.sTo}" oninput="hIn('sTo',this.value)" onkeypress="if(event.key==='Enter')act('addSouv')" oncompositionstart="hCompS()" oncompositionend="hCompE(this,'sTo')" class="border p-2 rounded w-24"><button type="button" onclick="act('addSouv')" class="bg-teal-600 text-white px-4 rounded">추가</button></div>
        <div class="bg-white rounded border">${d.souvenirs.map(x=>`<div class="flex justify-between p-2 border-b last:border-0 items-center"><span class="flex gap-2 items-center"><input type="checkbox" ${x.bought?'checked':''} onchange="act('togSouv',${x.id})"> <span class="${x.bought?'line-through text-gray-400':''}">${x.item}</span> <span class="text-xs bg-gray-100 px-1 rounded">${x.receiver}</span></span><button onclick="act('delSouv',${x.id})" class="text-gray-300 hover:text-red-500">x</button></div>`).join('')}</div>
      </div>`;
  }
  else if(st.tab === 'expense'){
    c.innerHTML = `
      <div class="space-y-4 a-f"><h3 class="font-bold border-b pb-1">가계부</h3>
        <div class="flex gap-2 flex-wrap"><input type="date" value="${st.inp.exDate}" onchange="hIn('exDate',this.value)" class="border p-2 rounded text-sm w-28"><select onchange="hIn('exCat',this.value)" class="border p-2 rounded text-sm"><option>식비</option><option>교통</option><option>숙박</option><option>쇼핑</option><option>기타</option></select><input id="ep-in" placeholder="내역" value="${st.inp.exItem}" oninput="hIn('exItem',this.value)" oncompositionstart="hCompS()" oncompositionend="hCompE(this,'exItem')" class="border p-2 rounded flex-1 min-w-[100px]"><input placeholder="금액" value="${st.inp.exCost}" oninput="hIn('exCost',this.value.replace(/[^0-9]/g,''))" onkeypress="if(event.key==='Enter')act('addExp')" class="border p-2 rounded w-24 text-right"><button type="button" onclick="act('addExp')" class="bg-teal-600 text-white px-4 rounded">추가</button></div>
        <table class="w-full text-sm text-left"><thead class="bg-gray-100"><tr><th class="p-2">날짜</th><th class="p-2">내역</th><th class="p-2 text-right">금액</th><th class="p-2 w-8"></th></tr></thead><tbody>${d.expenses.sort((a,b)=>new Date(b.date)-new Date(a.date)).map(x=>`<tr class="border-b"><td class="p-2 text-gray-500 text-xs">${x.date.slice(5)}</td><td class="p-2"><div><span class="text-xs bg-gray-100 px-1 rounded mr-1">${x.cat}</span>${x.item}</div></td><td class="p-2 text-right font-bold">${x.cost.toLocaleString()}</td><td class="p-2"><button onclick="act('delExp',${x.id})" class="text-gray-300 hover:text-red-500">x</button></td></tr>`).join('')}</tbody></table>
      </div>`;
  }
  
  document.getElementById('modal').classList.toggle('hidden', !st.modal);
  document.getElementById('icon-map-h').innerHTML = svg(I.Pin,'white');
};

init();
</script>
</body>
</html>
