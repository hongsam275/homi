<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚˜ë§Œì˜ ì—¬í–‰ í”Œë˜ë„ˆ</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ì»¤ìŠ¤í…€ ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¸°ê¸° (ì¼ì •í‘œ íƒ­) */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        /* ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ */
        .animate-pulse-fast {
            animation: pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans text-gray-800" id="app-container">
    <!-- UI will be rendered here by JavaScript -->
    <div class="flex h-screen items-center justify-center text-teal-600 font-bold animate-pulse-fast">
        í”Œë˜ë„ˆ ë¡œë”© ì¤‘...
    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Firestore ë””ë²„ê·¸ ë¡œê¹… ì„¤ì •
        setLogLevel('debug');

        // --- Configuration & Global Variables (MUST BE DEFINED HERE) ---
        const GOOGLE_MAPS_API_KEY = 'AIzaSyBwZ1hfLte8a0KcT9V2Tht3da_gi2tC4Rw'; // [ì¤‘ìš”] ì—¬ê¸°ì— Google Maps API Keyë¥¼ ì…ë ¥í•˜ì„¸ìš” (Places API í™œì„±í™” í•„ìˆ˜)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // Note: Corrected typo in __firebase_config usage
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Firebase Initialization
        let db, auth;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            window.db = db; // Attach to window for global access
            window.auth = auth;
        } catch (e) {
            console.error("Firebase initialization error:", e);
        }

        // Global State (Replaces React useState)
        let state = {
            data: null,
            userId: null,
            isAuthReady: false,
            activeTab: 'overview',
            showModal: false,
            selectedDayIndex: 0,
            isMapLoaded: false,
            isComposing: false, // í•œêµ­ì–´ ì…ë ¥ ì¤‘ ì—¬ë¶€ (Directly updated for stability)
            
            // Overview Inputs (Local temporary state for stability/composition fix)
            overviewInputs: { 
                destination: '', 
                startDate: '', 
                endDate: '' 
            },
            
            // Ephemeral Inputs (Add forms)
            inputs: {
                packingItem: '',
                souvenirItem: '',
                souvenirReceiver: '',
                expenseCategory: 'ì‹ë¹„',
                expenseItem: '',
                expenseCost: '',
                expenseDate: new Date().toISOString().split('T')[0],
                eventTime: '09:00',
                eventTitle: '',
                eventPlaceName: '',
                eventLat: null,
                eventLng: null
            },
        };
        
        const initialData = {
            destination: 'ì œì£¼ë„',
            startDate: '',
            endDate: '',
            packingList: [],
            schedule: [
                { id: Date.now(), day: 1, date: '', events: [] } 
            ],
            souvenirs: [],
            expenses: [] 
        };

        // References for Maps & Autocomplete
        const mapRef = {};
        const mapInstanceRef = { current: null };
        const markersRef = { current: [] };
        const autocompleteInstanceRef = { current: null };

        // --- State Management and Rendering ---

        /**
         * ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•˜ê³  UI ë Œë”ë§ì„ íŠ¸ë¦¬ê±°í•©ë‹ˆë‹¤.
         * ì´ í•¨ìˆ˜ëŠ” ì…ë ¥ ì•ˆì •ì„±ì„ ìœ„í•´ ì—°ì†ì ì¸ í‚¤ ì…ë ¥ì—ì„œëŠ” í˜¸ì¶œë˜ì§€ ì•Šì•„ì•¼ í•©ë‹ˆë‹¤.
         * (íƒ­ ì „í™˜, ë°ì´í„° ë¡œë“œ/ë³€ê²½, ì•„ì´í…œ ì¶”ê°€/ì‚­ì œ ì‹œ í˜¸ì¶œ)
         * @param {object} newState - ì—…ë°ì´íŠ¸í•  ìƒíƒœ ê°ì²´
         */
        function setState(newState) {
            Object.assign(state, newState);
            render();
        }

        // SVG Icons (Replaces Lucide React)
        const Icons = {
            Map: (c = 'currentColor') => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="${c}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><polygon points="3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21"/></svg>`,
            Calendar: (c = 'currentColor') => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="${c}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>`,
            CheckSquare: (c = 'currentColor') => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="${c}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 12l2 2 4-4"/></svg>`,
            Gift: (c = 'currentColor') => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="${c}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><rect x="3" y="8" width="18" height="4"/><path d="M12 8v13"/><path d="M19 12V6a2 2 0 0 0-2-2H7a2 2 0 0 0-2 2v6"/><path d="M21 12v1.8a2 2 0 0 1-1.12 1.83l-2.4 1.4a2 2 0 0 1-1.76 0l-2.4-1.4A2 2 0 0 1 12 13.8v-1.8"/><path d="M3 12v1.8a2 2 0 0 0 1.12 1.83l2.4 1.4a2 2 0 0 0 1.76 0l2.4-1.4A2 2 0 0 0 12 13.8v-1.8"/></svg>`,
            DollarSign: (c = 'currentColor') => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="${c}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>`,
            Plus: (c = 'currentColor') => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="${c}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>`,
            Trash2: (c = 'currentColor') => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="${c}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M15 2h-6l-1 4h8z"/></svg>`,
            MapPin: (c = 'currentColor') => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="${c}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><path d="M12 22s-8-4.5-8-11.8A8 8 0 0 1 12 2a8 8 0 0 1 8 8.2c0 7.3-8 11.8-8 11.8z"/><circle cx="12" cy="10" r="3"/></svg>`,
            RotateCcw: (c = 'currentColor') => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="${c}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><path d="M3 13a9 9 0 1 0 4-8"/><path d="M3 10v-3h3"/></svg>`,
            Search: (c = 'currentColor') => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="${c}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="absolute right-2 top-1/2 -translate-y-1/2 w-5 h-5 pointer-events-none"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>`,
        };

        // --- Firebase Logic ---

        const updateFirestore = async (newData) => {
            if (!db || !state.userId) return;
            const planDocRef = doc(db, 'artifacts', appId, 'users', state.userId, 'travelPlans', 'myPlanV3');
            try {
                // Remove Map objects if any, though it shouldn't happen here
                const sanitizedData = JSON.parse(JSON.stringify(newData)); 
                await setDoc(planDocRef, sanitizedData); 
            } catch (e) {
                console.error("Error updating document:", e);
            }
        };

        const startFirestoreListener = () => {
            if (!db || !state.userId) return;

            const planDocRef = doc(db, 'artifacts', appId, 'users', state.userId, 'travelPlans', 'myPlanV3');
            onSnapshot(planDocRef, (docSnap) => {
                let fetchedData;
                if (docSnap.exists()) {
                    fetchedData = docSnap.data();
                } else {
                    fetchedData = initialData;
                    updateFirestore(initialData); // ì´ˆê¸° ë°ì´í„° ì„¤ì •
                }
                
                // Firestore ë°ì´í„°ê°€ ë³€ê²½ë˜ë©´ ë¡œì»¬ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•˜ê³  ë Œë”ë§
                // Note: onSnapshot listener must still call setState/render to update UI
                setState({ 
                    data: fetchedData,
                    overviewInputs: {
                        destination: fetchedData.destination || '',
                        startDate: fetchedData.startDate || '',
                        endDate: fetchedData.endDate || '',
                    }
                });
                
                // Overview íƒ­ì´ í™œì„±í™”ë˜ì–´ ìˆê³  ë§µì´ ë¡œë“œë˜ì—ˆìœ¼ë©´ ë§ˆì»¤ ì—…ë°ì´íŠ¸
                if (state.activeTab === 'overview' && state.isMapLoaded) {
                     updateMapMarkers();
                }

            }, (error) => {
                console.error("Firestore Snapshot Error:", error);
            });
        };

        const authenticate = async () => {
            try {
                let user;
                if (initialAuthToken) {
                    const result = await signInWithCustomToken(auth, initialAuthToken);
                    user = result.user;
                } else {
                    const result = await signInAnonymously(auth);
                    user = result.user;
                }
                setState({ userId: user.uid, isAuthReady: true });
                startFirestoreListener();
            } catch (error) {
                console.error("Auth Error:", error);
                // Auth failed, still set ready to show initial data
                setState({ isAuthReady: true, data: initialData }); 
            }
        };

        // --- Input Composition & Stability Handlers (Key Fixes) ---

        // 1. í•œêµ­ì–´ ì…ë ¥ ì‹œì‘ ì‹œ í”Œë˜ê·¸ ì„¤ì • (render í˜¸ì¶œ ë°©ì§€ ìœ„í•´ ì§ì ‘ ìƒíƒœ ì—…ë°ì´íŠ¸)
        const handleCompositionStart = () => { 
            state.isComposing = true;
        };

        /**
         * 2. í•œêµ­ì–´ ì…ë ¥ ì¢…ë£Œ ì‹œ í”Œë˜ê·¸ í•´ì œ ë° ìµœì¢… ê°’ ì»¤ë°‹ ì²˜ë¦¬
         * @param {HTMLElement} element - ì…ë ¥ ì—˜ë¦¬ë¨¼íŠ¸
         * @param {string} key - state.inputs ë˜ëŠ” state.overviewInputsì˜ í‚¤
         * @param {boolean} commitToFirestore - Firestoreì— ì»¤ë°‹ì´ í•„ìš”í•œ ê²½ìš° (Overview í•„ë“œ)
         */
        const handleCompositionEnd = (element, key, commitToFirestore = false) => {
            // 1. Composition í”Œë˜ê·¸ í•´ì œ (setState ë°©ì§€)
            state.isComposing = false;
            
            // 2. Overview ë˜ëŠ” Ephemeral ìƒíƒœì— ìµœì¢… ê°’ ë°˜ì˜ (setState ë°©ì§€)
            if (commitToFirestore) {
                state.overviewInputs[key] = element.value;
            } else {
                state.inputs[key] = element.value;
            }

            // 3. Overview í•„ë“œì¸ ê²½ìš°ì—ë§Œ Firestore ì»¤ë°‹
            if (commitToFirestore) {
                commitOverviewChange(key, element.value);
            }
        };
        
        // 3. Ephemeral Input Handler (Form í•„ë“œ: Packing, Souvenir, Expense, Event)
        // **ì¤‘ìš”: render()ë¥¼ í˜¸ì¶œí•˜ì§€ ì•Šê³  ë¡œì»¬ ìƒíƒœë§Œ ì—…ë°ì´íŠ¸í•˜ì—¬ í¬ì»¤ìŠ¤ë¥¼ ìœ ì§€í•©ë‹ˆë‹¤.**
        const handleStableEphemeralInput = (key, value) => {
            state.inputs[key] = value;
            // Note: DOM value is already updated by the oninput event itself.
        };
        
        // 4. Overview Input Handler (Destination)
        // **ì¤‘ìš”: render()ë¥¼ í˜¸ì¶œí•˜ì§€ ì•Šê³  ë¡œì»¬ ìƒíƒœë§Œ ì—…ë°ì´íŠ¸í•˜ì—¬ í¬ì»¤ìŠ¤ë¥¼ ìœ ì§€í•©ë‹ˆë‹¤.**
        const handleStableOverviewInput = (key, value) => {
            state.overviewInputs[key] = value;
        };

        /**
         * 5. Overview Input Commit (onblur ë˜ëŠ” compositionend ì‹œ Firestoreì— ì €ì¥)
         * @param {string} key - state.overviewInputsì˜ í‚¤
         * @param {string|null} finalValue - compositionendì—ì„œ ì „ë‹¬ëœ ìµœì¢… ê°’ (ì—†ìœ¼ë©´ ë¡œì»¬ ìƒíƒœ ì‚¬ìš©)
         */
        const commitOverviewChange = (key, finalValue = null) => {
            // compositionendëŠ” finalValueë¥¼ ì „ë‹¬í•˜ì—¬ isComposing ì²´í¬ë¥¼ ìš°íšŒí•˜ê³  ì»¤ë°‹
            // onblurëŠ” isComposingì„ ì²´í¬í•˜ê³  ì»¤ë°‹ (compositionend ì§í›„ onblurê°€ ë°œìƒí•  ìˆ˜ ìˆê¸° ë•Œë¬¸)
            if (state.isComposing && finalValue === null) return; 
            
            const valueToCommit = finalValue ?? state.overviewInputs[key];
            if (state.data && state.data[key] !== valueToCommit) {
                const newData = { ...state.data, [key]: valueToCommit };
                updateFirestore(newData);
            }
        };
        
        // --- Maps Logic (unchanged) ---

        const loadGoogleMapsScript = () => {
            if (window.google && window.google.maps) {
                setState({ isMapLoaded: true });
                return;
            }
            if (!GOOGLE_MAPS_API_KEY) {
                console.warn("Google Maps API Key is missing. Maps will not load.");
                return;
            }
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&libraries=places`;
            script.async = true;
            script.defer = true;
            script.onload = () => setState({ isMapLoaded: true });
            document.head.appendChild(script);
        };
        
        const initOverviewMap = () => {
            if (!state.isMapLoaded || mapInstanceRef.current || !mapRef.overview) return;

            mapInstanceRef.current = new window.google.maps.Map(mapRef.overview, {
                center: { lat: 33.3846, lng: 126.5535 }, // Default Center (Jeju)
                zoom: 10,
            });
            updateMapMarkers();
        };

        const updateMapMarkers = () => {
            if (!mapInstanceRef.current || !state.data?.schedule) return;

            // Clear markers
            markersRef.current.forEach(m => m.setMap(null));
            markersRef.current = [];

            const bounds = new window.google.maps.LatLngBounds();
            let hasMarkers = false;
            const colors = ['red', 'blue', 'green', 'orange', 'purple', 'yellow'];

            state.data.schedule.forEach((day, idx) => {
                if(day.events) {
                    day.events.forEach(event => {
                        if (event.lat && event.lng) {
                            const color = colors[idx % colors.length];
                            const iconUrl = `http://maps.google.com/mapfiles/ms/icons/${color}-dot.png`;
                            
                            const marker = new window.google.maps.Marker({
                                position: { lat: event.lat, lng: event.lng },
                                map: mapInstanceRef.current,
                                title: event.title,
                                icon: iconUrl
                            });
                            
                            const infoWindow = new window.google.maps.InfoWindow({
                                content: `<div style="color:black"><b>Day ${day.day}</b><br/>${event.title}<br/>${event.time}</div>`
                            });
                            
                            marker.addListener("click", () => infoWindow.open(mapInstanceRef.current, marker));

                            markersRef.current.push(marker);
                            bounds.extend(marker.getPosition());
                            hasMarkers = true;
                        }
                    });
                }
            });

            if (hasMarkers) {
                mapInstanceRef.current.fitBounds(bounds);
            }
        };
        
        const initAutocomplete = () => {
            // AutocompleteëŠ” Schedule íƒ­ì—ì„œë§Œ í™œì„±í™”ë©ë‹ˆë‹¤.
            if (!state.isMapLoaded || state.activeTab !== 'schedule' || !document.getElementById('autocomplete-input')) return;

            const input = document.getElementById('autocomplete-input');

            // ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ í´ë¦¬ì–´
            if (autocompleteInstanceRef.current) {
                window.google.maps.event.clearInstanceListeners(autocompleteInstanceRef.current);
            }

            autocompleteInstanceRef.current = new window.google.maps.places.Autocomplete(input);
            
            const listener = autocompleteInstanceRef.current.addListener("place_changed", () => {
                const place = autocompleteInstanceRef.current.getPlace();
                if (place.geometry) {
                    // Ephemeral Input Handler ì‚¬ìš©
                    handleStableEphemeralInput('eventPlaceName', place.name);
                    handleStableEphemeralInput('eventLat', place.geometry.location.lat());
                    handleStableEphemeralInput('eventLng', place.geometry.location.lng());
                    input.value = place.name; // Autocompleteê°€ ì„ íƒí•œ ì´ë¦„ìœ¼ë¡œ input ì—…ë°ì´íŠ¸
                }
            });
        };

        // --- Action Handlers (Calling setState/render only when necessary) ---

        const addDay = () => {
            const newDayNum = state.data.schedule.length + 1;
            const newSchedule = [...state.data.schedule, { id: Date.now(), day: newDayNum, date: '', events: [] }];
            updateFirestore({ ...state.data, schedule: newSchedule });
            setState({ selectedDayIndex: newSchedule.length - 1 }); 
        };

        const deleteDay = (e, index) => {
            e.stopPropagation();
            if (state.data.schedule.length <= 1) return;
            const newSchedule = state.data.schedule.filter((_, i) => i !== index).map((d, i) => ({ ...d, day: i + 1 }));
            updateFirestore({ ...state.data, schedule: newSchedule });
            setState({ selectedDayIndex: Math.max(0, index - 1) });
        };

        const updateDayDate = (date) => {
            const newSchedule = [...state.data.schedule];
            newSchedule[state.selectedDayIndex].date = date;
            updateFirestore({ ...state.data, schedule: newSchedule });
        };

        const addEventToDay = () => {
            // eventTitleì€ handleStableEphemeralInputì„ í†µí•´ state.inputsì— ë°˜ì˜ë¨
            if (!state.inputs.eventTitle) return;
            
            const newEvent = {
                id: Date.now(),
                time: state.inputs.eventTime,
                title: state.inputs.eventTitle,
                placeName: state.inputs.eventPlaceName,
                lat: state.inputs.eventLat,
                lng: state.inputs.eventLng
            };

            const newSchedule = [...state.data.schedule];
            if (!newSchedule[state.selectedDayIndex].events) newSchedule[state.selectedDayIndex].events = [];
            
            newSchedule[state.selectedDayIndex].events.push(newEvent);
            newSchedule[state.selectedDayIndex].events.sort((a, b) => a.time.localeCompare(b.time));

            updateFirestore({ ...state.data, schedule: newSchedule });
            
            // Ephemeral inputs reset (This calls setState/render, which is fine after form submission)
            const resetInputs = { 
                eventTitle: '', eventPlaceName: '', eventLat: null, eventLng: null 
            };
            setState({ inputs: { ...state.inputs, ...resetInputs }});
            const autocompleteInput = document.getElementById('autocomplete-input');
            if (autocompleteInput) autocompleteInput.value = '';
        };

        const deleteEvent = (eventIndex) => {
            const newSchedule = [...state.data.schedule];
            newSchedule[state.selectedDayIndex].events.splice(eventIndex, 1);
            updateFirestore({ ...state.data, schedule: newSchedule });
        };
        
        const addExpense = () => {
            // expenseCost, expenseItemì€ handleStableEphemeralInputì„ í†µí•´ state.inputsì— ë°˜ì˜ë¨
            const cost = parseInt(state.inputs.expenseCost.replace(/,/g, ''));
            if (!state.inputs.expenseItem || isNaN(cost)) return;
            const newExpenses = [...state.data.expenses, { id: Date.now(), category: state.inputs.expenseCategory, item: state.inputs.expenseItem, cost, date: state.inputs.expenseDate }];
            updateFirestore({ ...state.data, expenses: newExpenses });
            
            const resetInputs = { expenseItem: '', expenseCost: '' };
            setState({ inputs: { ...state.inputs, ...resetInputs }});
        };

        const deleteExpense = (id) => {
            const newExpenses = state.data.expenses.filter(e => e.id !== id);
            updateFirestore({ ...state.data, expenses: newExpenses });
        };

        const addPacking = () => {
            // packingItemì€ handleStableEphemeralInputì„ í†µí•´ state.inputsì— ë°˜ì˜ë¨
            if (!state.inputs.packingItem) return;
            updateFirestore({ ...state.data, packingList: [...state.data.packingList, { id: Date.now(), text: state.inputs.packingItem, checked: false }]});
            setState({ inputs: { ...state.inputs, packingItem: '' }});
        };

        const addSouvenir = () => {
            // souvenirItem, souvenirReceiverëŠ” handleStableEphemeralInputì„ í†µí•´ state.inputsì— ë°˜ì˜ë¨
            if (!state.inputs.souvenirItem) return;
            updateFirestore({ ...state.data, souvenirs: [...state.data.souvenirs, { id: Date.now(), item: state.inputs.souvenirItem, receiver: state.inputs.souvenirReceiver, bought: false }]});
            setState({ inputs: { ...state.inputs, souvenirItem: '', souvenirReceiver: '' }});
        };

        const toggleCheck = (list, id, field='checked') => {
            const updated = state.data[list].map(i => i.id === id ? { ...i, [field]: !i[field] } : i);
            updateFirestore({ ...state.data, [list]: updated });
        };
        
        const deleteItem = (list, id) => {
            const updated = state.data[list].filter(i => i.id !== id);
            updateFirestore({ ...state.data, [list]: updated });
        };
        
        // --- Rendering Functions ---

        const getTabsHTML = () => {
            const tabs = [
                { id: 'overview', label: 'ì—¬í–‰ ê°œìš”', icon: Icons.Map },
                { id: 'schedule', label: 'ì¼ì •í‘œ', icon: Icons.Calendar },
                { id: 'packing', label: 'ì¤€ë¹„ë¬¼', icon: Icons.CheckSquare },
                { id: 'souvenir', label: 'ê¸°ë…í’ˆ', icon: Icons.Gift },
                { id: 'expense', label: 'ê°€ê³„ë¶€', icon: Icons.DollarSign },
            ];

            return tabs.map(tab => `
                <button
                    onclick="setState({ activeTab: '${tab.id}' })"
                    class="flex-1 min-w-[50px] py-1 px-2 rounded-md flex flex-col items-center justify-center text-xs gap-0.5 transition-all
                    ${state.activeTab === tab.id ? 'bg-teal-100 text-teal-700 font-bold shadow-inner' : 'text-gray-500 hover:bg-gray-100'}"
                >
                    ${tab.icon('currentColor')} ${tab.label}
                </button>
            `).join('');
        };

        const getOverviewContentHTML = () => {
            const totalExpense = state.data?.expenses?.reduce((sum, item) => sum + Number(item.cost), 0) || 0;
            
            if (state.activeTab !== 'overview') return '';

            // Map initialization must be done after the map container is in the DOM
            setTimeout(() => {
                mapRef.overview = document.getElementById('overview-map-container');
                if (state.isMapLoaded && mapRef.overview) initOverviewMap();
            }, 0);


            return `
               <div class="space-y-6 animate-fade-in">
                  <h2 class="text-2xl font-bold text-gray-800 border-b pb-2">âœˆï¸ ì—¬í–‰ ê¸°ë³¸ ì •ë³´</h2>
                  
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                     <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">ì—¬í–‰ì§€</label>
                        <input 
                            id="destination-input"
                            type="text" 
                            value="${state.overviewInputs.destination}" 
                            oninput="handleStableOverviewInput('destination', this.value)" 
                            onblur="commitOverviewChange('destination')"
                            oncompositionstart="handleCompositionStart()"
                            oncompositionend="handleCompositionEnd(this, 'destination', true)"
                            class="w-full border rounded-lg p-3 outline-none focus:ring-2 focus:ring-teal-500"
                            placeholder="ì—¬í–‰ì§€ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”"
                        />
                     </div>
                     <div class="bg-red-50 border border-red-100 rounded-lg p-3 flex flex-col justify-center">
                        <label class="text-sm font-medium text-red-500">ì´ ì§€ì¶œ (ê°€ê³„ë¶€ ì—°ë™)</label>
                        <div class="text-2xl font-bold text-red-700">${totalExpense.toLocaleString()}ì›</div>
                     </div>
                  </div>

                  <div class="grid grid-cols-2 gap-4">
                     <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">ì‹œì‘ì¼</label>
                        <input 
                            type="date" 
                            value="${state.overviewInputs.startDate}" 
                            onchange="commitOverviewChange('startDate', this.value)" 
                            class="w-full border rounded-lg p-2"
                        />
                     </div>
                     <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">ì¢…ë£Œì¼</label>
                        <input 
                            type="date" 
                            value="${state.overviewInputs.endDate}" 
                            onchange="commitOverviewChange('endDate', this.value)" 
                            class="w-full border rounded-lg p-2"
                        />
                     </div>
                  </div>

                  <!-- Google Map Overview -->
                  <div class="mt-6">
                     <label class="block text-sm font-medium text-gray-600 mb-2">ğŸ“ ì—¬í–‰ ì§€ë„ (ì¼ì •í‘œ í•€ í‘œì‹œ)</label>
                     <div class="w-full h-96 bg-gray-200 rounded-lg overflow-hidden border relative">
                        <div id="overview-map-container" class="w-full h-full"></div>
                        ${!state.isMapLoaded ? '<div class="absolute inset-0 flex items-center justify-center text-gray-500">ì§€ë„ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘... (API í‚¤ í™•ì¸ í•„ìš”)</div>' : ''}
                     </div>
                  </div>
               </div>
            `;
        };

        const getScheduleContentHTML = () => {
            if (state.activeTab !== 'schedule') return '';
            
            const currentDay = state.data.schedule[state.selectedDayIndex];
            
            // Initialize Autocomplete when the tab is active
            setTimeout(() => initAutocomplete(), 0);

            const dayTabsHTML = state.data.schedule.map((day, idx) => `
                <button 
                    onclick="setState({ selectedDayIndex: ${idx} })"
                    class="flex-shrink-0 px-4 py-2 rounded-full text-sm font-bold transition whitespace-nowrap border
                    ${state.selectedDayIndex === idx ? 'bg-teal-600 text-white border-teal-600 shadow-md' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'}"
                >
                    Day ${day.day}
                    ${idx > 0 ? `<span onclick="deleteDay(event, ${idx})" class="ml-2 opacity-60 hover:opacity-100 hover:text-red-300">Ã—</span>` : ''}
                </button>
            `).join('');

            const eventsListHTML = currentDay.events && currentDay.events.length > 0 ? 
                currentDay.events.map((event, eIdx) => `
                    <div key="${event.id}" class="relative pl-10 group">
                        <div class="absolute left-[11px] top-4 w-3 h-3 bg-teal-500 rounded-full border-2 border-white shadow-sm z-10"></div>
                        <div class="bg-white border border-gray-100 rounded-lg p-3 shadow-sm hover:shadow-md transition flex justify-between items-start">
                            <div>
                                <div class="flex items-center gap-2">
                                    <span class="font-bold text-gray-800 text-lg">${event.time}</span>
                                    <span class="text-gray-900 font-medium">${event.title}</span>
                                </div>
                                ${event.placeName ? `
                                    <div class="text-xs text-gray-500 mt-1 flex items-center gap-1">
                                        ${Icons.MapPin('currentColor')} ${event.placeName}
                                    </div>
                                ` : ''}
                            </div>
                            <button onclick="deleteEvent(${eIdx})" class="text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition">
                                ${Icons.Trash2('currentColor')}
                            </button>
                        </div>
                    </div>
                `).join('') : 
                '<div class="text-center text-gray-400 py-10 pl-4">ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>';

            return `
               <div class="space-y-4 animate-fade-in">
                  <h2 class="text-2xl font-bold text-gray-800">ğŸ“… ìƒì„¸ ì¼ì •</h2>
                  
                  <!-- Horizontal Day Tabs -->
                  <div class="flex items-center gap-2 overflow-x-auto pb-2 no-scrollbar">
                     ${dayTabsHTML}
                     <button onclick="addDay()" class="flex-shrink-0 px-3 py-2 rounded-full bg-gray-100 text-gray-600 hover:bg-gray-200 border border-gray-300">
                        ${Icons.Plus('currentColor')}
                     </button>
                  </div>

                  <!-- Selected Day Content -->
                  <div class="bg-white rounded-xl shadow-lg p-6 min-h-[400px]">
                     <div class="flex justify-between items-center border-b pb-3 mb-4">
                        <h3 class="text-lg font-bold text-teal-700">Day ${currentDay.day}</h3>
                        <input 
                            type="date" 
                            value="${currentDay.date}" 
                            onchange="updateDayDate(this.value)"
                            class="border rounded px-2 py-1 text-sm text-gray-600"
                        />
                     </div>

                     <!-- Add Event Form -->
                     <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 mb-6 grid grid-cols-1 md:grid-cols-[100px_1fr_1fr_auto] gap-2 items-center">
                        <input 
                            type="time" 
                            value="${state.inputs.eventTime}" 
                            onchange="handleStableEphemeralInput('eventTime', this.value)"
                            class="border rounded p-2 text-sm w-full"
                        />
                        <input 
                            id="event-title-input"
                            type="text" 
                            placeholder="ì¼ì • ì œëª© (ì˜ˆ: ì ì‹¬ ì‹ì‚¬)" 
                            value="${state.inputs.eventTitle}" 
                            oninput="handleStableEphemeralInput('eventTitle', this.value)"
                            oncompositionstart="handleCompositionStart()"
                            oncompositionend="handleCompositionEnd(this, 'eventTitle')"
                            class="border rounded p-2 text-sm w-full"
                        />
                        <div class="relative w-full">
                            <input 
                                id="autocomplete-input"
                                type="text" 
                                placeholder="ì¥ì†Œ ê²€ìƒ‰ (êµ¬ê¸€ë§µ)" 
                                class="border rounded p-2 text-sm w-full pr-8"
                            />
                            ${Icons.Search('text-gray-400')}
                        </div>
                        <button onclick="addEventToDay()" class="bg-teal-600 text-white p-2 rounded hover:bg-teal-700 w-full md:w-auto">
                            ${Icons.Plus('white')}
                        </button>
                     </div>

                     <!-- Events List -->
                     <div class="space-y-3 relative">
                        <div class="absolute left-4 top-0 bottom-0 w-0.5 bg-gray-200"></div>
                        ${eventsListHTML}
                     </div>
                  </div>
               </div>
            `;
        };
        
        const getPackingContentHTML = () => {
            if (state.activeTab !== 'packing') return '';
            
            const listHTML = state.data.packingList.map(item => `
                <div 
                    key="${item.id}" 
                    onclick="toggleCheck('packingList', ${item.id})" 
                    class="flex items-center justify-between p-3 rounded-lg border cursor-pointer transition-all 
                    ${item.checked ? 'bg-gray-100 border-gray-200' : 'bg-white border-teal-100 shadow-sm hover:shadow'}">
                    <div class="flex items-center gap-3 overflow-hidden">
                        ${item.checked ? Icons.CheckSquare('text-teal-600') : '<div class="w-4 h-4 border rounded border-gray-300"></div>'}
                        <span class="truncate ${item.checked ? 'text-gray-400 line-through' : 'text-gray-800'}">${item.text}</span>
                    </div>
                    <button onclick="event.stopPropagation(); deleteItem('packingList', ${item.id});" class="text-gray-300 hover:text-red-500">${Icons.Trash2('currentColor')}</button>
                </div>
            `).join('');

            return `
                <div class="space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800 border-b pb-2">ğŸ’ ì¤€ë¹„ë¬¼ ë¦¬ìŠ¤íŠ¸</h2>
                    <div class="flex gap-2">
                        <input 
                            id="packing-input"
                            type="text" 
                            value="${state.inputs.packingItem}" 
                            oninput="handleStableEphemeralInput('packingItem', this.value)" 
                            oncompositionstart="handleCompositionStart()"
                            oncompositionend="handleCompositionEnd(this, 'packingItem')"
                            onkeypress="if(event.key === 'Enter') addPacking()" 
                            placeholder="ì¤€ë¹„ë¬¼ ì…ë ¥..." 
                            class="flex-1 border rounded-lg p-2"
                        />
                        <button onclick="addPacking()" class="bg-teal-600 text-white px-4 rounded-lg hover:bg-teal-700">ì¶”ê°€</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-4">
                        ${listHTML}
                    </div>
                </div>
            `;
        };
        
        const getSouvenirContentHTML = () => {
            if (state.activeTab !== 'souvenir') return '';
            
            const rowsHTML = state.data.souvenirs.map(s => `
                <tr key="${s.id}" class="border-b hover:bg-gray-50">
                    <td class="p-3 text-center"><input type="checkbox" ${s.bought ? 'checked' : ''} onchange="toggleCheck('souvenirs', ${s.id}, 'bought')" class="w-4 h-4 text-teal-600"/></td>
                    <td class="p-3 ${s.bought ? 'line-through text-gray-400' : ''}">${s.item}</td>
                    <td class="p-3 text-gray-600 font-medium">${s.receiver}</td>
                    <td class="p-3 text-center"><button onclick="deleteItem('souvenirs', ${s.id})" class="text-gray-300 hover:text-red-500">${Icons.Trash2('currentColor')}</button></td>
                </tr>
            `).join('');

            return `
                <div class="space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800 border-b pb-2">ğŸ ê¸°ë…í’ˆ ëª©ë¡</h2>
                    <div class="flex gap-2 mb-4 p-4 bg-gray-50 rounded-lg flex-wrap">
                        <input 
                            id="souvenir-item-input"
                            type="text" 
                            value="${state.inputs.souvenirItem}" 
                            oninput="handleStableEphemeralInput('souvenirItem', this.value)" 
                            oncompositionstart="handleCompositionStart()"
                            oncompositionend="handleCompositionEnd(this, 'souvenirItem')"
                            placeholder="ìƒí’ˆëª…" 
                            class="flex-[2] border rounded p-2 text-sm min-w-[100px]"
                        />
                        <input 
                            id="souvenir-receiver-input"
                            type="text" 
                            value="${state.inputs.souvenirReceiver}" 
                            oninput="handleStableEphemeralInput('souvenirReceiver', this.value)" 
                            oncompositionstart="handleCompositionStart()"
                            oncompositionend="handleCompositionEnd(this, 'souvenirReceiver')"
                            onkeypress="if(event.key === 'Enter') addSouvenir()" 
                            placeholder="ë°›ëŠ” ì‚¬ëŒ" 
                            class="flex-1 border rounded p-2 text-sm min-w-[100px]"
                        />
                        <button onclick="addSouvenir()" class="bg-teal-600 text-white px-4 rounded hover:bg-teal-700 text-sm">ì¶”ê°€</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-teal-50 text-teal-800">
                                <tr>
                                    <th class="p-3 w-16 text-center">êµ¬ë§¤</th>
                                    <th class="p-3">ìƒí’ˆëª…</th>
                                    <th class="p-3">ë°›ëŠ” ì‚¬ëŒ</th>
                                    <th class="p-3 w-16 text-center">ì‚­ì œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${rowsHTML}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        };

        const getExpenseContentHTML = () => {
            if (state.activeTab !== 'expense') return '';
            
            const totalExpense = state.data?.expenses?.reduce((sum, item) => sum + Number(item.cost), 0) || 0;
            const sortedExpenses = state.data.expenses.sort((a,b) => new Date(b.date) - new Date(a.date));
            
            const rowsHTML = sortedExpenses.map(e => `
                <tr key="${e.id}" class="border-b hover:bg-gray-50">
                    <td class="p-3 text-gray-500 text-xs">${e.date}</td>
                    <td class="p-3"><span class="bg-gray-200 text-gray-600 text-xs px-2 py-1 rounded">${e.category}</span></td>
                    <td class="p-3">${e.item}</td>
                    <td class="p-3 text-right font-bold text-gray-700">${e.cost.toLocaleString()}ì›</td>
                    <td class="p-3 text-center"><button onclick="deleteExpense(${e.id})" class="text-gray-300 hover:text-red-500">${Icons.Trash2('currentColor')}</button></td>
                </tr>
            `).join('');

            return `
                <div class="space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800 border-b pb-2">ğŸ’¸ ì—¬í–‰ ê°€ê³„ë¶€</h2>
                    
                    <!-- Total Only -->
                    <div class="bg-red-50 p-6 rounded-lg border border-red-100 text-center">
                        <p class="text-sm text-red-500 mb-1">í˜„ì¬ê¹Œì§€ ì´ ì§€ì¶œ</p>
                        <p class="text-3xl font-bold text-red-700">${totalExpense.toLocaleString()}ì›</p>
                    </div>

                    <div class="flex gap-2 mb-4 flex-wrap">
                        <input type="date" value="${state.inputs.expenseDate}" onchange="handleStableEphemeralInput('expenseDate', this.value)" class="border rounded p-2 text-sm"/>
                        <select value="${state.inputs.expenseCategory}" onchange="handleStableEphemeralInput('expenseCategory', this.value)" class="border rounded p-2 text-sm">
                            <option>ì‹ë¹„</option><option>êµí†µ</option><option>ìˆ™ë°•</option><option>ì‡¼í•‘</option><option>ê¸°íƒ€</option>
                        </select>
                        <input 
                            id="expense-item-input"
                            type="text" 
                            value="${state.inputs.expenseItem}" 
                            oninput="handleStableEphemeralInput('expenseItem', this.value)" 
                            oncompositionstart="handleCompositionStart()"
                            oncompositionend="handleCompositionEnd(this, 'expenseItem')"
                            placeholder="ë‚´ìš©" 
                            class="flex-1 border rounded p-2 text-sm min-w-[120px]"
                        />
                        <input 
                            id="expense-cost-input"
                            type="text" 
                            inputMode="numeric" 
                            value="${state.inputs.expenseCost}" 
                            oninput="handleStableEphemeralInput('expenseCost', this.value.replace(/[^0-9]/g, ''))" 
                            oncompositionstart="handleCompositionStart()"
                            oncompositionend="handleCompositionEnd(this, 'expenseCost')"
                            onkeypress="if(event.key === 'Enter') addExpense()" 
                            placeholder="ê¸ˆì•¡" 
                            class="w-24 border rounded p-2 text-sm text-right"
                        />
                        <button onclick="addExpense()" class="bg-teal-600 text-white px-4 rounded hover:bg-teal-700 text-sm">ì¶”ê°€</button>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse text-sm">
                            <thead class="bg-gray-100 sticky top-0">
                                <tr>
                                    <th class="p-3 w-24">ë‚ ì§œ</th>
                                    <th class="p-3 w-20">ë¶„ë¥˜</th>
                                    <th class="p-3">ë‚´ì—­</th>
                                    <th class="p-3 text-right">ê¸ˆì•¡</th>
                                    <th class="p-3 w-12 text-center">ì‚­ì œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${rowsHTML}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        };
        
        const getModalHTML = () => {
            if (!state.showModal) return '';
            return `
                <div id="confirmation-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">âš ï¸ ë°ì´í„° ì´ˆê¸°í™”</h3>
                        <p class="text-gray-600 mb-6">ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
                        <div class="flex justify-end gap-3">
                            <button onclick="setState({ showModal: false })" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">ì·¨ì†Œ</button>
                            <button onclick="updateFirestore(initialData); setState({ showModal: false });" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">í™•ì¸</button>
                        </div>
                    </div>
                </div>
            `;
        };


        // Main Render Function
        function render() {
            const appContainer = document.getElementById('app-container');

            if (!state.isAuthReady || !state.data) {
                appContainer.innerHTML = `
                    <div class="flex h-screen items-center justify-center text-teal-600 font-bold animate-pulse-fast">
                        í”Œë˜ë„ˆ ë¡œë”© ì¤‘...
                    </div>
                `;
                return;
            }

            let tabContentHTML = '';
            switch (state.activeTab) {
                case 'overview': tabContentHTML = getOverviewContentHTML(); break;
                case 'schedule': tabContentHTML = getScheduleContentHTML(); break;
                case 'packing': tabContentHTML = getPackingContentHTML(); break;
                case 'souvenir': tabContentHTML = getSouvenirContentHTML(); break;
                case 'expense': tabContentHTML = getExpenseContentHTML(); break;
            }

            const totalHTML = `
                <div class="min-h-screen bg-gray-50 font-sans text-gray-800 pb-20">
                    <!-- Header -->
                    <header class="bg-teal-600 text-white p-4 shadow-md sticky top-0 z-20">
                        <div class="max-w-4xl mx-auto flex justify-between items-center">
                            <h1 class="text-xl font-bold flex items-center gap-2">
                                ${Icons.MapPin('white')} ë‚˜ë§Œì˜ ì—¬í–‰ í”Œë˜ë„ˆ
                            </h1>
                            <div class="flex items-center gap-3">
                                <button onclick="setState({ showModal: true })" class="text-xs bg-teal-700 hover:bg-teal-800 px-3 py-1 rounded flex items-center gap-1 transition">
                                    ${Icons.RotateCcw('white')} ì´ˆê¸°í™”
                                </button>
                            </div>
                        </div>
                    </header>

                    <div class="max-w-4xl mx-auto p-4">
                        <!-- Navigation Tabs -->
                        <div class="flex gap-1 mb-6 bg-white p-2 rounded-lg shadow-sm overflow-x-auto justify-between">
                            ${getTabsHTML()}
                        </div>
                        
                        <!-- Tab Content -->
                        <div id="tab-content">
                            ${tabContentHTML}
                        </div>
                    </div>
                    
                    <!-- Confirmation Modal -->
                    ${getModalHTML()}
                </div>
            `;
            
            // Render the main structure
            appContainer.innerHTML = totalHTML;
        }

        // --- Initialization ---
        
        // Expose stable functions to global scope for HTML event handlers
        window.setState = setState;
        window.updateFirestore = updateFirestore;
        
        // Stabilized Input Handlers
        window.handleCompositionStart = handleCompositionStart;
        window.handleCompositionEnd = handleCompositionEnd;
        window.handleStableOverviewInput = handleStableOverviewInput;
        window.commitOverviewChange = commitOverviewChange;
        window.handleStableEphemeralInput = handleStableEphemeralInput;
        
        // Action Handlers
        window.addDay = addDay;
        window.deleteDay = deleteDay;
        window.updateDayDate = updateDayDate;
        window.addEventToDay = addEventToDay;
        window.deleteEvent = deleteEvent;
        window.addExpense = addExpense;
        window.deleteExpense = deleteExpense;
        window.addPacking = addPacking;
        window.addSouvenir = addSouvenir;
        window.toggleCheck = toggleCheck;
        window.deleteItem = deleteItem;


        // Start the application lifecycle
        document.addEventListener('DOMContentLoaded', () => {
            loadGoogleMapsScript(); // Load Google Maps first
            authenticate(); // Then start Firebase auth and data sync
        });
    </script>
</body>
</html>

