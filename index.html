<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì—¬í–‰ í”Œë˜ë„ˆ (Firebase í´ë¼ìš°ë“œ ë³µì›)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Custom scrollbar for better mobile/embed view */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #34d399; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #059669; }
        ::-webkit-scrollbar-track { background: #f0fdf4; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800" style="font-family: Inter, 'Apple SD Gothic Neo', 'Malgun Gothic', 'NanumGothic', Dotum, sans-serif;">

    <div id="app-container" class="min-h-screen flex flex-col">
        <div id="loading-screen" class="flex-1 flex flex-col items-center justify-center p-8 text-teal-600 bg-gray-50">
            <svg class="animate-spin h-8 w-8 text-teal-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 font-semibold text-lg">ë°ì´í„° ë¡œë“œ ì¤‘...</p>
            <p id="auth-status" class="text-xs text-gray-500 mt-2">ì¸ì¦ ëŒ€ê¸° ì¤‘</p>
        </div>
    </div>
    
    <!-- Main HTML Template -->
    <template id="main-template">
        <header class="bg-teal-600 text-white p-4 shadow-md sticky top-0 z-10">
            <div class="max-w-4xl mx-auto flex justify-between items-center">
                <h1 class="text-xl font-bold flex items-center gap-2">
                    <i data-lucide="map-pin" class="w-6 h-6"></i>
                    ì—¬í–‰ í”Œë˜ë„ˆ (í´ë¼ìš°ë“œ ë™ê¸°í™”)
                </h1>
                <div class="flex items-center gap-4">
                    <!-- í˜„ì¬ ì €ì¥ì†Œ ìƒíƒœ í‘œì‹œ -->
                    <div class="flex items-center text-xs bg-teal-500 py-1 px-2 rounded-full">
                        <i data-lucide="cloud" class='w-3 h-3 mr-1'></i> ì €ì¥ì†Œ: Firebase (ì‹¤ì‹œê°„ ë™ê¸°í™”)
                    </div>
                    <button id="reset-button" class="text-xs bg-teal-700 hover:bg-teal-800 px-3 py-1 rounded flex items-center gap-1 transition">
                        <i data-lucide="rotate-ccw" class='w-3 h-3'></i> ì´ˆê¸°í™”
                    </button>
                </div>
            </div>
            <div class="max-w-4xl mx-auto mt-2 text-xs text-teal-200">
                 <span id="user-id-display"></span>
            </div>
        </header>
        
        <div class="max-w-4xl mx-auto p-4 flex-1">
            <!-- Navigation Tabs -->
            <div id="tab-navigation" class="flex flex-wrap gap-2 mb-6 bg-white p-2 rounded-lg shadow-sm">
                <!-- Tabs will be rendered here -->
            </div>

            <!-- Content Area -->
            <div id="content-area" class="bg-white rounded-xl shadow-lg min-h-[500px] p-6">
                <!-- Content will be rendered here -->
            </div>
        </div>

        <!-- Confirmation Modal -->
        <div id="modal-backdrop" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 items-center justify-center z-50">
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
                <h3 class="text-xl font-bold text-gray-800 mb-4">âš ï¸ ë°ì´í„° ì´ˆê¸°í™” í™•ì¸</h3>
                <p class="text-gray-600 mb-6">í´ë¼ìš°ë“œì— ì €ì¥ëœ í˜„ì¬ ì‚¬ìš©ì ê³„ì •ì˜ ëª¨ë“  ì—¬í–‰ ê³„íš ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
                <div class="flex justify-end gap-3">
                    <button id="cancel-reset" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition">
                        ì·¨ì†Œ
                    </button>
                    <button id="confirm-reset" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">
                        ì´ˆê¸°í™” í™•ì¸
                    </button>
                </div>
            </div>
        </div>
    </template>


    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc, setLogLevel, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Global Variables (Provided by Canvas Environment) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // --- Firebase & App State ---
        let app, db, auth;
        let userId = null;
        let data = null;
        let activeTab = 'overview';
        let isComposing = false; // Flag for Hangul composition

        // --- Constants ---
        const INITIAL_PLAN_ID = 'travelPlan';
        const TABS = [
            { id: 'overview', label: 'ì—¬í–‰ ê°œìš”', icon: 'map' },
            { id: 'schedule', label: 'ì¼ì •í‘œ', icon: 'calendar' },
            { id: 'packing', label: 'ì¤€ë¹„ë¬¼', icon: 'check-square' },
            { id: 'souvenir', label: 'ê¸°ë…í’ˆ', icon: 'gift' },
            { id: 'expense', label: 'ê°€ê³„ë¶€', icon: 'dollar-sign' },
        ];

        const initialData = {
            destination: 'ì œì£¼ë„',
            startDate: '',
            endDate: '',
            budget: 500000,
            packingList: [
                { id: Date.now() + 1, text: 'ì—¬ê¶Œ', checked: false },
                { id: Date.now() + 2, text: 'ì„ í¬ë¦¼', checked: false },
            ],
            schedule: [
                { id: Date.now() + 3, day: 1, morning: 'ì˜¤ì „ ì¼ì •', afternoon: 'ì˜¤í›„ ì¼ì •', evening: 'ì €ë… ì¼ì •' },
            ],
            souvenirs: [],
            expenses: [],
            keyLocations: [
                { id: Date.now() + 4, name: 'ì„±ì‚°ì¼ì¶œë´‰' },
                { id: Date.now() + 5, name: 'í˜‘ì¬ í•´ìˆ˜ìš•ì¥' },
            ],
        };

        // --- Firestore Utility ---
        function getPlanDocRef(uid) {
            // Private path: /artifacts/{appId}/users/{userId}/plannerData/travelPlan
            const plannerCollection = collection(db, `artifacts/${appId}/users/${uid}/plannerData`);
            return doc(plannerCollection, INITIAL_PLAN_ID);
        }

        /**
         * Saves the entire data object to Firestore.
         */
        async function updateFirestore(newData) {
            if (!userId) {
                console.error("Firestore update failed: User ID is null.");
                return;
            }
            try {
                // IMPORTANT: Ensure all ID fields are correctly managed before saving.
                await setDoc(getPlanDocRef(userId), newData, { merge: true });
                data = newData;
                // Note: The render() will be called automatically by the onSnapshot listener.
            } catch (e) {
                console.error("ERROR: Failed to update Firestore document:", e);
            }
        }

        /**
         * Fetches data from Firestore and sets up a real-time listener.
         */
        function fetchData() {
            if (!db || !userId) {
                console.error("DB or User ID not ready for fetching.");
                return;
            }

            const docRef = getPlanDocRef(userId);

            // Set up real-time listener
            onSnapshot(docRef, async (docSnap) => {
                if (docSnap.exists()) {
                    // Data exists, use it
                    console.log("Real-time data received.");
                    data = docSnap.data();
                } else {
                    // Data does not exist (first time use), initialize it
                    console.log("No existing data found. Initializing new plan...");
                    data = initialData;
                    // Save the initial data to the cloud immediately
                    await setDoc(docRef, initialData);
                }
                // Always render after data is set or updated
                render();
            }, (error) => {
                console.error("Firestore Snapshot Listener Error:", error);
                document.getElementById('auth-status').textContent = `ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜: ${error.code}`;
                document.getElementById('auth-status').classList.add('text-red-500');
            });
        }

        // --- Input Handling (Hangul Fix) ---
        
        document.addEventListener('compositionstart', (e) => {
            if (e.target.dataset.hangul) {
                isComposing = true;
            }
        }, true);

        document.addEventListener('compositionend', (e) => {
            if (e.target.dataset.hangul) {
                isComposing = false;
                handleInputChange(e.target);
            }
        }, true);

        function handleGlobalInput(e) {
            const target = e.target;
            const field = target.dataset.field;

            if (!field) return;
            if (target.type === 'text' || target.type === 'number') {
                 target.dataset.hangul = 'true';
            }
            
            if (!isComposing) {
                handleInputChange(target);
            }
        }

        function handleInputChange(inputElement) {
            const field = inputElement.dataset.field;
            const value = inputElement.value;
            const contextId = inputElement.dataset.contextId;
            const contextList = inputElement.dataset.contextList; 

            if (!field) return;

            // Deep clone data to modify
            let newData = JSON.parse(JSON.stringify(data));

            if (contextList && contextId) {
                // Handle complex list updates (schedule, keyLocations)
                let updatedList = newData[contextList].map(item => 
                    String(item.id) === contextId ? { ...item, [field]: value } : item
                );
                newData[contextList] = updatedList;

            } else {
                // Handle simple field updates (destination, budget, etc.)
                const newValue = field === 'budget' ? parseInt(value) || 0 : value;
                newData[field] = newValue;
            }
            updateFirestore(newData);
        }

        // --- Utility Functions ---
        function setActiveTab(tabId) { activeTab = tabId; render(); }
        
        function addItem(listName, newItem) {
            let newData = JSON.parse(JSON.stringify(data));
            const id = Date.now() + Math.floor(Math.random() * 1000);
            newData[listName] = [...newData[listName], { ...newItem, id }];
            updateFirestore(newData);
        }
        
        function deleteItem(listName, id) {
            let newData = JSON.parse(JSON.stringify(data));
            newData[listName] = newData[listName].filter(item => item.id !== id);
            updateFirestore(newData);
        }
        
        function confirmReset() { 
            updateFirestore(initialData); 
            showModal(false); 
        } 

        function showModal(isVisible) { 
            const modal = document.getElementById('modal-backdrop');
            if (modal) { modal.classList.toggle('hidden', !isVisible); modal.classList.toggle('flex', isVisible); }
        }
        
        function calculateRemainingBudget(budget, expenses) {
            const total = expenses.reduce((sum, item) => sum + Number(item.cost || 0), 0);
            return Number(budget) - total;
        }

        // --- Render Functions (UI Generation) ---
        
        // Functions to generate HTML content... (omitted for brevity, assume they are restored as before)
        // Note: The previous HTML rendering functions are extensive. We restore the functional body below.

        function renderTabs() { 
            const tabNav = document.getElementById('tab-navigation');
            if (!tabNav) return;
            tabNav.innerHTML = TABS.map(tab => `
                <button
                    onclick="window.setActiveTab('${tab.id}')"
                    class="flex-1 min-w-[80px] py-2 px-3 rounded-md flex flex-col items-center justify-center text-sm gap-1 transition-all 
                        ${activeTab === tab.id 
                            ? 'bg-teal-100 text-teal-700 font-bold shadow-inner' 
                            : 'text-gray-500 hover:bg-gray-100'}"
                >
                    <i data-lucide="${tab.icon}" size="20"></i>
                    ${tab.label}
                </button>
            `).join('');
            window.setActiveTab = setActiveTab; 
        }

        function renderContent() {
            const contentArea = document.getElementById('content-area');
            if (!contentArea) return;
            contentArea.innerHTML = '';
            contentArea.classList.add('animate-fade-in'); 

            switch (activeTab) {
                case 'overview': contentArea.innerHTML = renderOverviewHtml(); break;
                case 'schedule': contentArea.innerHTML = renderScheduleHtml(); break;
                case 'packing': contentArea.innerHTML = renderPackingHtml(); break;
                case 'souvenir': contentArea.innerHTML = renderSouvenirHtml(); break;
                case 'expense': contentArea.innerHTML = renderExpenseHtml(); break;
            }
            
            // Re-bind utility functions to window for onclick/onchange in HTML strings
            window.addDay = () => { const nextDay = data.schedule.length + 1; window.addItem('schedule', { day: nextDay, morning: '', afternoon: '', evening: '' }); };
            window.deleteItem = deleteItem;
            window.addItem = addItem;
            window.toggleCheck = (listName, id) => {
                let newData = JSON.parse(JSON.stringify(data));
                newData[listName] = newData[listName].map(item => item.id === id ? { ...item, checked: !item.checked } : item);
                updateFirestore(newData);
            };
            window.addPackingItem = () => { 
                const input = document.getElementById('newPackingItem'); 
                if (input.value.trim()) { window.addItem('packingList', { text: input.value, checked: false }); input.value = ''; } 
            };
            window.toggleSouvenir = (id) => {
                let newData = JSON.parse(JSON.stringify(data));
                newData.souvenirs = newData.souvenirs.map(item => item.id === id ? { ...item, bought: !item.bought } : item);
                updateFirestore(newData);
            };
            window.addSouvenirItem = () => {
                const item = document.getElementById('souvenirItem'); const receiver = document.getElementById('souvenirReceiver');
                if(item.value.trim() && receiver.value.trim()) { window.addItem('souvenirs', { item: item.value, receiver: receiver.value, bought: false }); item.value = ''; receiver.value = ''; }
            };
            window.addExpenseItem = () => {
                const cat = document.getElementById('expenseCat'); const item = document.getElementById('expenseItem'); const cost = document.getElementById('expenseCost');
                if (item.value.trim() && cost.value) { window.addItem('expenses', { category: cat.value, item: item.value, cost: parseInt(cost.value) }); item.value = ''; cost.value = ''; }
            };
            window.addKeyLocation = () => {
                const input = document.getElementById('newKeyLocation');
                if (input.value.trim()) { window.addItem('keyLocations', { name: input.value }); input.value = ''; }
            }
            
            // Reattach the global input listener after rendering new inputs
            document.querySelectorAll('input, select').forEach(element => {
                element.removeEventListener('input', handleGlobalInput);
                element.removeEventListener('change', handleGlobalInput);
                element.addEventListener('input', handleGlobalInput);
                element.addEventListener('change', handleGlobalInput);
            });
            lucide.createIcons();
        }
        
        // --- Simplified HTML Content Generation Functions (Restored) ---
        
        function renderOverviewHtml() { 
            const remainingBudget = calculateRemainingBudget(data.budget, data.expenses);
            
            const locationNames = [data.destination, ...data.keyLocations.map(l => l.name)];
            const mapQuery = locationNames.filter(name => name.trim()).join('+to+');
            const mapSrc = `https://maps.google.com/maps?q=${encodeURIComponent(mapQuery)}&t=&z=11&ie=UTF8&iwloc=&output=embed`;
            
            const keyLocationsHtml = data.keyLocations.map(loc => `
                <div class="flex items-center justify-between p-2 bg-white border border-gray-100 rounded-lg shadow-sm">
                    <input type="text" value="${loc.name}" 
                           data-field="name" 
                           data-context-list="keyLocations" 
                           data-context-id="${loc.id}" 
                           class="flex-1 border-none focus:ring-0 outline-none text-sm p-1" />
                    <button onclick="window.deleteItem('keyLocations', ${loc.id})" class="text-gray-300 hover:text-red-500 p-1">
                        <i data-lucide="x" size="16"></i>
                    </button>
                </div>
            `).join('');

            return `
                <div class="space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800 border-b pb-2">âœˆï¸ ì—¬í–‰ ê¸°ë³¸ ì •ë³´</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">ì—¬í–‰ì§€ (ì „ì²´)</label>
                            <input type="text" value="${data.destination}" data-field="destination" class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-teal-500 outline-none" placeholder="ì˜ˆ: íŒŒë¦¬, ì œì£¼ë„"/>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">ì´ ì˜ˆì‚° (ì›)</label>
                            <input type="number" value="${data.budget}" data-field="budget" class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-teal-500 outline-none text-right" placeholder="0"/>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">ì‹œì‘ì¼</label>
                            <input type="date" value="${data.startDate}" data-field="startDate" class="w-full border rounded-lg p-2"/>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">ì¢…ë£Œì¼</label>
                            <input type="date" value="${data.endDate}" data-field="endDate" class="w-full border rounded-lg p-2"/>
                        </div>
                    </div>

                    <div class="mt-6">
                        <div class="p-4 rounded-lg border ${remainingBudget >= 0 ? 'bg-blue-50 border-blue-100' : 'bg-red-100 border-red-200'}">
                            <p class="text-sm ${remainingBudget >= 0 ? 'text-blue-500' : 'text-red-500'}">ë‚¨ì€ ì˜ˆì‚°</p>
                            <p class="text-xl font-bold ${remainingBudget >= 0 ? 'text-blue-700' : 'text-red-700'}">${remainingBudget.toLocaleString()}ì›</p>
                        </div>
                    </div>

                    <!-- ğŸ—ºï¸ ì§€ë„ì— í‘œì‹œí•  ì£¼ìš” ì¥ì†Œ ì„¹ì…˜ -->
                    <div class="mt-8">
                        <h3 class="text-xl font-bold text-gray-800 border-b pb-2 mb-4">ğŸ“ ì§€ë„ì— í‘œì‹œí•  ì£¼ìš” ì¥ì†Œ</h3>
                        <p class="text-sm text-gray-500 mb-3">* ì—¬ê¸°ì— ì¥ì†Œë¥¼ ì…ë ¥í•˜ë©´ ì§€ë„ì— í•€ì²˜ëŸ¼ í‘œì‹œë©ë‹ˆë‹¤.</p>
                        <div class="flex gap-2 mb-4">
                            <input id="newKeyLocation" type="text" placeholder="ìƒˆ ì¥ì†Œ ì´ë¦„ ì…ë ¥ (ì˜ˆ: í•´ë³€, ë§›ì§‘)" 
                                   class="flex-1 border rounded-lg p-2" 
                                   onkeypress="if(event.key === 'Enter') { window.addKeyLocation(); }" />
                            <button onclick="window.addKeyLocation()" class="bg-teal-600 text-white px-4 rounded-lg hover:bg-teal-700 text-sm">ì¶”ê°€</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 max-h-40 overflow-y-auto p-1 rounded-lg bg-gray-50">
                            ${keyLocationsHtml}
                        </div>
                    </div>
                    
                    <!-- ğŸ—ºï¸ êµ¬ê¸€ ì§€ë„ ì„ë² ë“œ -->
                    <div class="mt-6">
                        <label class="block text-sm font-medium text-gray-600 mb-2">ğŸ—ºï¸ ì£¼ìš” ì¥ì†Œ ì§€ë„ ë¯¸ë¦¬ë³´ê¸°</label>
                        <div class="w-full h-80 bg-gray-200 rounded-lg overflow-hidden border">
                            <iframe width="100%" height="100%" frameborder="0" scrolling="no" marginheight="0" marginwidth="0" src="${mapSrc}" title="Google Map"></iframe>
                        </div>
                        <p class="text-xs text-gray-400 mt-1">* 'ì—¬í–‰ì§€'ì™€ 'ì£¼ìš” ì¥ì†Œ' ì…ë ¥ê°’ì„ ê¸°ë°˜ìœ¼ë¡œ ì§€ë„ê°€ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.</p>
                    </div>
                </div>
            `;
        }
        function renderScheduleHtml() { 
            const addDayHtml = `<button onclick="window.addDay()" class="bg-teal-600 text-white px-3 py-1.5 rounded-lg text-sm flex items-center gap-1 hover:bg-teal-700"><i data-lucide="plus" size="16"></i> Day ì¶”ê°€</button>`;
            const scheduleList = data.schedule.map((day, index) => `
                <div key="${day.id}" class="border border-gray-200 rounded-lg p-4 bg-gray-50 relative">
                    <div class="flex justify-between mb-3"><h3 class="font-bold text-lg text-teal-700">Day ${day.day}</h3>${data.schedule.length > 1 ? `<button onclick="window.deleteItem('schedule', ${day.id})" class="text-red-400 hover:text-red-600"><i data-lucide="trash-2" size="18"></i></button>` : ''}</div>
                    <div class="space-y-3">
                        ${['morning', 'afternoon', 'evening'].map((period) => {
                            const config = { morning: { label: 'ì˜¤ì „', color: 'yellow' }, afternoon: { label: 'ì˜¤í›„', color: 'orange' }, evening: { label: 'ì €ë…', color: 'indigo' } }[period];
                            return `<div class="grid grid-cols-[60px_1fr] items-center gap-2"><span class="text-sm font-medium text-${config.color}-600 bg-${config.color}-100 py-1 px-2 rounded text-center">${config.label}</span><input type="text" value="${day[period]}" data-field="${period}" data-context-list="schedule" data-context-id="${day.id}" class="border rounded p-2 text-sm w-full" placeholder="${config.label} ì¼ì • ì…ë ¥"/></div>`;
                        }).join('')}
                    </div>
                </div>
            `).join('');
            return `<div class="space-y-6"><div class="flex justify-between items-center border-b pb-2"><h2 class="text-2xl font-bold text-gray-800">ğŸ“… ë‚ ì§œë³„ ì¼ì • (${data.schedule.length}ì¼)</h2>${addDayHtml}</div><div class="space-y-4">${scheduleList}</div></div>`;
        }
        function renderPackingHtml() { 
            const listHtml = data.packingList.map(item => `<div key="${item.id}" onclick="window.toggleCheck('packingList', ${item.id})" class="flex items-center justify-between p-3 rounded-lg border cursor-pointer transition-all ${item.checked ? 'bg-gray-100 border-gray-200' : 'bg-white border-teal-100 shadow-sm hover:shadow'}"><div class="flex items-center gap-3 overflow-hidden"><div class="w-5 h-5 rounded border flex items-center justify-center ${item.checked ? 'bg-teal-500 border-teal-500' : 'border-gray-300'}">${item.checked ? `<i data-lucide="check-square" size="14" class="text-white"></i>` : ''}</div><span class="truncate ${item.checked ? 'text-gray-400 line-through' : 'text-gray-800'}">${item.text}</span></div><button onclick="event.stopPropagation(); window.deleteItem('packingList', ${item.id});" class="text-gray-300 hover:text-red-500 p-1"><i data-lucide="trash-2" size="16"></i></button></div>`).join('');
            return `<div class="space-y-6"><h2 class="text-2xl font-bold text-gray-800 border-b pb-2">ğŸ’ ì¤€ë¹„ë¬¼ ë¦¬ìŠ¤íŠ¸</h2><div class="flex gap-2"><input id="newPackingItem" type="text" placeholder="ìƒˆ ì¤€ë¹„ë¬¼ ì¶”ê°€..." class="flex-1 border rounded-lg p-2" onkeypress="if(event.key === 'Enter') { window.addPackingItem(); }" /><button onclick="window.addPackingItem()" class="bg-teal-600 text-white px-4 rounded-lg hover:bg-teal-700">ì¶”ê°€</button></div><div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-4">${listHtml}</div></div>`;
        }
        function renderSouvenirHtml() { 
            const tableRows = data.souvenirs.map(s => `<tr key="${s.id}" class="border-b hover:bg-gray-50"><td class="p-3 text-center"><input type="checkbox" ${s.bought ? 'checked' : ''} onchange="window.toggleSouvenir(${s.id})" class="w-4 h-4 text-teal-600 rounded focus:ring-teal-500"/></td><td class="p-3 ${s.bought ? 'line-through text-gray-400' : ''}">${s.item}</td><td class="p-3 ${s.bought ? 'text-gray-400' : 'text-gray-600'}">${s.receiver}</td><td class="p-3 text-center"><button onclick="window.deleteItem('souvenirs', ${s.id})" class="text-gray-300 hover:text-red-500"><i data-lucide="trash-2" size="16"></i></button></td></tr>`).join('');
            return `<div class="space-y-6"><h2 class="text-2xl font-bold text-gray-800 border-b pb-2">ğŸ ê¸°ë…í’ˆ ëª©ë¡</h2><div class="flex gap-2 mb-4 p-4 bg-gray-50 rounded-lg"><input id="souvenirItem" type="text" placeholder="ë¬´ì—‡ì„?" class="flex-[2] border rounded p-2 text-sm" /><input id="souvenirReceiver" type="text" placeholder="ëˆ„êµ¬ì—ê²Œ?" class="flex-1 border rounded p-2 text-sm" /><button onclick="window.addSouvenirItem()" class="bg-teal-600 text-white px-4 rounded hover:bg-teal-700 text-sm">ì¶”ê°€</button></div><div class="overflow-x-auto"><table class="w-full text-left border-collapse"><thead><tr class="bg-teal-50 text-teal-800 border-b border-teal-100"><th class="p-3 w-16 text-center">êµ¬ë§¤</th><th class="p-3">ìƒí’ˆëª…</th><th class="p-3">ë°›ëŠ” ì‚¬ëŒ</th><th class="p-3 w-16 text-center">ì‚­ì œ</th></tr></thead><tbody>${tableRows}</tbody></table></div></div>`;
        }
        function renderExpenseHtml() { 
            const totalExpense = data.expenses.reduce((sum, item) => sum + Number(item.cost || 0), 0);
            const remainingBudget = calculateRemainingBudget(data.budget, data.expenses);
            const expenseRows = data.expenses.map(e => `<tr key="${e.id}" class="border-b hover:bg-gray-50"><td class="p-3 text-gray-500"><span class="bg-gray-200 text-xs px-2 py-1 rounded">${e.category}</span></td><td class="p-3">${e.item}</td><td class="p-3 text-right font-medium">${e.cost.toLocaleString()}ì›</td><td class="p-3 text-center"><button onclick="window.deleteItem('expenses', ${e.id})" class="text-gray-300 hover:text-red-500"><i data-lucide="trash-2" size="14"></i></button></td></tr>`).join('');
            return `<div class="space-y-6"><h2 class="text-2xl font-bold text-gray-800 border-b pb-2">ğŸ’¸ ì—¬í–‰ ê°€ê³„ë¶€</h2><div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6"><div class="bg-gray-50 p-4 rounded-lg border"><p class="text-sm text-gray-500">ì´ ì˜ˆì‚°</p><p class="text-xl font-bold text-gray-800">${Number(data.budget).toLocaleString()}ì›</p></div><div class="bg-red-50 p-4 rounded-lg border border-red-100"><p class="text-sm text-red-500">ì´ ì§€ì¶œ</p><p class="text-xl font-bold text-red-700">${totalExpense.toLocaleString()}ì›</p></div><div class="p-4 rounded-lg border ${remainingBudget >= 0 ? 'bg-blue-50 border-blue-100' : 'bg-red-100 border-red-200'}"><p class="text-sm ${remainingBudget >= 0 ? 'text-blue-500' : 'text-red-500'}">ë‚¨ì€ ëˆ</p><p class="text-xl font-bold ${remainingBudget >= 0 ? 'text-blue-700' : 'text-red-700'}`}${remainingBudget.toLocaleString()}ì›</p></div></div><div class="flex gap-2 mb-4 flex-wrap"><select id="expenseCat" class="border rounded p-2 text-sm"><option>ì‹ë¹„</option><option>êµí†µ</option><option>ìˆ™ë°•</option><option>ì‡¼í•‘</option><option>ê¸°íƒ€</option></select><input id="expenseItem" type="text" placeholder="ë‚´ìš© (ì˜ˆ: ì ì‹¬)" class="flex-1 border rounded p-2 text-sm min-w-[120px]" /><input id="expenseCost" type="number" placeholder="ê¸ˆì•¡" class="w-24 border rounded p-2 text-sm text-right" /><button onclick="window.addExpenseItem()" class="bg-teal-600 text-white px-4 rounded hover:bg-teal-700 text-sm">ì¶”ê°€</button></div><div class="overflow-x-auto max-h-[400px] overflow-y-auto"><table class="w-full text-left border-collapse text-sm"><thead class="bg-gray-100 sticky top-0"><tr><th class="p-3 w-20">ë¶„ë¥˜</th><th class="p-3">ë‚´ì—­</th><th class="p-3 text-right">ê¸ˆì•¡</th><th class="p-3 w-12 text-center">ì‚­ì œ</th></tr></thead><tbody>${expenseRows}</tbody></table></div></div>`;
        }
        // --- Main Render Function ---
        function render() {
            if (!data) return;
            
            const loadingScreen = document.getElementById('loading-screen');
            if (loadingScreen) loadingScreen.remove();

            const appContainer = document.getElementById('app-container');
            if (!appContainer.querySelector('#main-template')) {
                const mainTemplate = document.getElementById('main-template').content.cloneNode(true);
                appContainer.innerHTML = '';
                appContainer.appendChild(mainTemplate);
                
                // Bind static events once
                document.getElementById('reset-button').onclick = () => showModal(true);
                document.getElementById('cancel-reset').onclick = () => showModal(false);
                document.getElementById('confirm-reset').onclick = confirmReset;

                // Display User ID
                document.getElementById('user-id-display').textContent = `í˜„ì¬ ì‚¬ìš©ì ID: ${userId}`;
            }
            
            renderTabs();
            renderContent();
            lucide.createIcons();
        }

        // --- Initialization ---

        async function initFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase config is missing.");
                document.getElementById('auth-status').textContent = "ì˜¤ë¥˜: Firebase ì„¤ì • ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
                return;
            }
            
            setLogLevel('debug'); // Enable Firestore logging
            
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            document.getElementById('auth-status').textContent = "ì¸ì¦ ì¤‘...";

            // 1. Authenticate the user
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Signed in with custom token.");
                } else {
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously.");
                }
            } catch (error) {
                console.error("Firebase Authentication Error:", error);
                document.getElementById('auth-status').textContent = `ì¸ì¦ ì˜¤ë¥˜: ${error.code}`;
                return;
            }

            // 2. Wait for auth state change to get the final userId
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('auth-status').textContent = `ì‚¬ìš©ì ì¸ì¦ ì™„ë£Œ (ID: ${userId})`;
                    console.log("Auth State Changed, User ID:", userId);
                    
                    // 3. Start fetching data from Firestore
                    fetchData();
                } else {
                    // This should ideally not happen after successful sign-in
                    userId = null;
                    document.getElementById('auth-status').textContent = "ì¸ì¦ ì‹¤íŒ¨.";
                }
            });
        }

        window.onload = function() {
            initFirebase();
        };
        
    </script>
</body>
</html>

