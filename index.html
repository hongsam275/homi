import { Map, Calendar, CheckSquare, Gift, DollarSign, Plus, Trash2, MapPin, Save, RotateCcw, User } from 'lucide-react';

// Firebase Imports
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, setDoc, onSnapshot } from 'firebase/firestore';

// Global variables provided by the environment
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// Firebase Initialization (Singleton pattern)
let db, auth;
try {
    const app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    auth = getAuth(app);
} catch (e) {
    console.error("Firebase initialization error:", e);
}

export default function TravelPlanner() {
  const [activeTab, setActiveTab] = useState('overview');
  const [data, setData] = useState(null); // Firestore 데이터를 가져올 때까지 null
  const [userId, setUserId] = useState(null);
  const [isAuthReady, setIsAuthReady] = useState(false);
  const [showModal, setShowModal] = useState(false); // Custom Modal State

  // 기본 데이터 구조
  const initialData = {
    destination: '제주도',
    startDate: '',
    endDate: '',
    budget: 0,
    packingList: [
      { id: Date.now() + 1, text: '여권', checked: false },
      { id: Date.now() + 2, text: '충전기', checked: false },
      { id: Date.now() + 3, text: '상비약', checked: false },
    ],
    schedule: [
      { id: Date.now() + 4, day: 1, morning: '', afternoon: '', evening: '' },
    ],
    souvenirs: [
      { id: Date.now() + 5, item: '초콜릿', receiver: '팀장님', bought: false },
    ],
    expenses: [
      { id: Date.now() + 6, category: '항공권', item: '비행기표', cost: 0 },
    ]
  };

  // --- Firestore Data Persistence Function ---
  // Firestore에 데이터를 업데이트하는 범용 함수
  const updateFirestore = useCallback(async (newData) => {
    if (!db || !userId) return;
    const planDocRef = doc(db, 'artifacts', appId, 'users', userId, 'travelPlans', 'myPlan');
    try {
      // setDoc을 사용하여 문서 전체를 업데이트합니다.
      await setDoc(planDocRef, newData); 
    } catch (e) {
      console.error("Error updating document:", e);
    }
  }, [userId]);

  // --- 1. Authentication Setup ---
  useEffect(() => {
    if (!auth) return;

    // Firebase 인증 리스너 설정
    const unsubscribeAuth = onAuthStateChanged(auth, (user) => {
        if (user) {
            setUserId(user.uid);
        } else {
            // Unauthenticated: sign in anonymously if no token
            if (!initialAuthToken) {
                signInAnonymously(auth).catch(error => console.error("Anonymous Sign-In Error:", error));
            }
        }
        setIsAuthReady(true);
    });

    // Custom Token 인증 시도
    const authenticate = async () => {
        try {
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            }
        } catch (error) {
            console.error("Firebase Auth Error:", error);
            // Fallback to anonymous if token fails
            signInAnonymously(auth).catch(error => console.error("Anonymous Sign-In Fallback Error:", error));
        }
    };

    authenticate();

    return () => unsubscribeAuth();
  }, []); // Run only once for initialization

  // --- 2. Firestore Real-time Listener ---
  useEffect(() => {
    if (!db || !userId || !isAuthReady) {
        // 인증 준비가 되었지만 데이터가 아직 로드되지 않은 경우 초기 데이터 설정
        if (isAuthReady && !data) setData(initialData); 
        return;
    }

    const planDocRef = doc(db, 'artifacts', appId, 'users', userId, 'travelPlans', 'myPlan');

    // 실시간 스냅샷 리스너 설정
    const unsubscribeSnapshot = onSnapshot(planDocRef, (docSnap) => {
        if (docSnap.exists()) {
            // 데이터가 존재하면 로컬 상태 업데이트
            setData(docSnap.data());
        } else {
            // 데이터가 없으면 초기 데이터로 초기화하고 Firestore에 저장
            console.log("No travel plan found. Initializing new plan.");
            setData(initialData);
            updateFirestore(initialData).catch(e => console.error("Error setting initial doc:", e));
        }
    }, (error) => {
        console.error("Firestore Snapshot Error:", error);
    });

    return () => unsubscribeSnapshot();
  }, [db, userId, isAuthReady, updateFirestore]); // userId나 auth 상태가 변경되면 다시 실행

  if (!isAuthReady || data === null) {
    return (
      <div className="flex justify-center items-center h-screen bg-gray-50">
        <p className="text-xl text-teal-600">여행 데이터를 불러오는 중...</p>
      </div>
    );
  }


  // --- Data Manipulation Logic (Updates Firestore) ---
  const handleInputChange = (field, value) => {
    const newData = { ...data, [field]: value };
    updateFirestore(newData);
  };

  const toggleCheck = (listName, id) => {
    const updatedList = data[listName].map(item => 
      item.id === id ? { ...item, checked: !item.checked } : item
    );
    updateFirestore({ ...data, [listName]: updatedList });
  };
  
  const toggleSouvenir = (id) => {
    const updatedList = data.souvenirs.map(item => 
      item.id === id ? { ...item, bought: !item.bought } : item
    );
    updateFirestore({ ...data, souvenirs: updatedList });
  };

  const addItem = (listName, newItem) => {
    const updatedList = [...data[listName], { ...newItem, id: Date.now() }];
    updateFirestore({ ...data, [listName]: updatedList });
  };

  const deleteItem = (listName, id) => {
    const updatedList = data[listName].filter(item => item.id !== id);
    updateFirestore({ ...data, [listName]: updatedList });
  };

  const updateSchedule = (id, field, value) => {
    const updatedList = data.schedule.map(day => 
      day.id === id ? { ...day, [field]: value } : day
    );
    updateFirestore({ ...data, schedule: updatedList });
  };

  const addDay = () => {
    const nextDay = data.schedule.length + 1;
    addItem('schedule', { day: nextDay, morning: '', afternoon: '', evening: '' });
  };

  const updateExpense = (id, field, value) => {
    const updatedList = data.expenses.map(item => 
      item.id === id ? { ...item, [field]: value } : item
    );
    updateFirestore({ ...data, expenses: updatedList });
  };

  const totalExpense = data.expenses.reduce((sum, item) => sum + Number(item.cost), 0);
  const remainingBudget = Number(data.budget) - totalExpense;

  const handleReset = () => {
    setShowModal(true);
  };
  
  const confirmReset = () => {
    updateFirestore(initialData);
    setShowModal(false);
  };
  
  const cancelReset = () => {
    setShowModal(false);
  };


  return (
    <div className="min-h-screen bg-gray-50 font-sans text-gray-800">
      {/* 헤더 */}
      <header className="bg-teal-600 text-white p-4 shadow-md sticky top-0 z-10">
        <div className="max-w-4xl mx-auto flex justify-between items-center">
          <h1 className="text-xl font-bold flex items-center gap-2">
            <MapPin className="w-6 h-6" />
            나만의 여행 플래너 (클라우드 동기화)
          </h1>
          <div className="flex items-center gap-4">
             <div className="flex items-center text-xs bg-teal-500 py-1 px-2 rounded-full">
                <User size={12} className="mr-1"/> ID: {userId}
             </div>
             <button 
                onClick={handleReset}
                className="text-xs bg-teal-700 hover:bg-teal-800 px-3 py-1 rounded flex items-center gap-1 transition"
             >
                <RotateCcw size={12} /> 초기화
             </button>
          </div>
        </div>
      </header>

      <div className="max-w-4xl mx-auto p-4">
        {/* 네비게이션 탭 */}
        <div className="flex flex-wrap gap-2 mb-6 bg-white p-2 rounded-lg shadow-sm">
          {[
            { id: 'overview', label: '여행 개요', icon: Map },
            { id: 'schedule', label: '일정표', icon: Calendar },
            { id: 'packing', label: '준비물', icon: CheckSquare },
            { id: 'souvenir', label: '기념품', icon: Gift },
            { id: 'expense', label: '가계부', icon: DollarSign },
          ].map(tab => (
            <button
              key={tab.id}
              onClick={() => setActiveTab(tab.id)}
              className={`flex-1 min-w-[80px] py-2 px-3 rounded-md flex flex-col items-center justify-center text-sm gap-1 transition-all
                ${activeTab === tab.id 
                  ? 'bg-teal-100 text-teal-700 font-bold shadow-inner' 
                  : 'text-gray-500 hover:bg-gray-100'}`}
            >
              <tab.icon size={20} />
              {tab.label}
            </button>
          ))}
        </div>

        {/* 컨텐츠 영역 */}
        <div className="bg-white rounded-xl shadow-lg min-h-[500px] p-6">
          
          {/* 1. 여행 개요 & 지도 */}
          {activeTab === 'overview' && (
            <div className="space-y-6 animate-fade-in">
              <h2 className="text-2xl font-bold text-gray-800 border-b pb-2">✈️ 여행 기본 정보</h2>
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-600 mb-1">여행지</label>
                  <input 
                    type="text" 
                    value={data.destination}
                    onChange={(e) => handleInputChange('destination', e.target.value)}
                    className="w-full border rounded-lg p-3 focus:ring-2 focus:ring-teal-500 outline-none"
                    placeholder="예: 파리, 제주도"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-600 mb-1">총 예산 (원)</label>
                  <input 
                    type="number" 
                    value={data.budget}
                    onChange={(e) => handleInputChange('budget', e.target.value)}
                    className="w-full border rounded-lg p-3 focus:ring-2 focus:ring-teal-500 outline-none text-right"
                    placeholder="0"
                  />
                </div>
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-600 mb-1">시작일</label>
                  <input 
                    type="date" 
                    value={data.startDate}
                    onChange={(e) => handleInputChange('startDate', e.target.value)}
                    className="w-full border rounded-lg p-2"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-600 mb-1">종료일</label>
                  <input 
                    type="date" 
                    value={data.endDate}
                    onChange={(e) => handleInputChange('endDate', e.target.value)}
                    className="w-full border rounded-lg p-2"
                  />
                </div>
              </div>

              <div className="mt-6">
                <label className="block text-sm font-medium text-gray-600 mb-2">📍 구글 지도 ({data.destination})</label>
                <div className="w-full h-80 bg-gray-200 rounded-lg overflow-hidden border">
                  <iframe 
                    width="100%" 
                    height="100%" 
                    frameBorder="0" 
                    scrolling="no" 
                    marginHeight="0" 
                    marginWidth="0" 
                    src={`https://maps.google.com/maps?q=${encodeURIComponent(data.destination)}&t=&z=13&ie=UTF8&iwloc=&output=embed`}
                    title="Google Map"
                  ></iframe>
                </div>
                <p className="text-xs text-gray-400 mt-1">* 여행지를 입력하면 지도가 업데이트됩니다.</p>
              </div>
            </div>
          )}

          {/* 2. 일정표 */}
          {activeTab === 'schedule' && (
            <div className="space-y-6">
              <div className="flex justify-between items-center border-b pb-2">
                <h2 className="text-2xl font-bold text-gray-800">📅 날짜별 일정</h2>
                <button onClick={addDay} className="bg-teal-600 text-white px-3 py-1.5 rounded-lg text-sm flex items-center gap-1 hover:bg-teal-700">
                  <Plus size={16} /> Day 추가
                </button>
              </div>

              <div className="space-y-4">
                {data.schedule.map((day, index) => (
                  <div key={day.id} className="border border-gray-200 rounded-lg p-4 bg-gray-50 relative">
                    <div className="flex justify-between mb-3">
                      <h3 className="font-bold text-lg text-teal-700">Day {day.day}</h3>
                      {index > 0 && (
                        <button onClick={() => deleteItem('schedule', day.id)} className="text-red-400 hover:text-red-600">
                          <Trash2 size={18} />
                        </button>
                      )}
                    </div>
                    <div className="space-y-3">
                      <div className="grid grid-cols-[60px_1fr] items-center gap-2">
                        <span className="text-sm font-medium text-yellow-600 bg-yellow-100 py-1 px-2 rounded text-center">오전</span>
                        <input 
                          type="text" 
                          value={day.morning}
                          onChange={(e) => updateSchedule(day.id, 'morning', e.target.value)}
                          className="border rounded p-2 text-sm w-full"
                          placeholder="오전 일정 입력"
                        />
                      </div>
                      <div className="grid grid-cols-[60px_1fr] items-center gap-2">
                        <span className="text-sm font-medium text-orange-600 bg-orange-100 py-1 px-2 rounded text-center">오후</span>
                        <input 
                          type="text" 
                          value={day.afternoon}
                          onChange={(e) => updateSchedule(day.id, 'afternoon', e.target.value)}
                          className="border rounded p-2 text-sm w-full"
                          placeholder="오후 일정 입력"
                        />
                      </div>
                      <div className="grid grid-cols-[60px_1fr] items-center gap-2">
                        <span className="text-sm font-medium text-indigo-600 bg-indigo-100 py-1 px-2 rounded text-center">저녁</span>
                        <input 
                          type="text" 
                          value={day.evening}
                          onChange={(e) => updateSchedule(day.id, 'evening', e.target.value)}
                          className="border rounded p-2 text-sm w-full"
                          placeholder="저녁 일정 입력"
                        />
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* 3. 준비물 체크리스트 */}
          {activeTab === 'packing' && (
            <div className="space-y-6">
              <h2 className="text-2xl font-bold text-gray-800 border-b pb-2">🎒 준비물 리스트</h2>
              
              <div className="flex gap-2">
                <input 
                  type="text" 
                  id="newPackingItem" 
                  placeholder="새 준비물 추가..." 
                  className="flex-1 border rounded-lg p-2"
                  onKeyPress={(e) => {
                    if (e.key === 'Enter') {
                      if(e.target.value.trim()) {
                        addItem('packingList', { text: e.target.value, checked: false });
                        e.target.value = '';
                      }
                    }
                  }}
                />
                <button 
                  onClick={() => {
                    const input = document.getElementById('newPackingItem');
                    if(input.value.trim()) {
                      addItem('packingList', { text: input.value, checked: false });
                      input.value = '';
                    }
                  }}
                  className="bg-teal-600 text-white px-4 rounded-lg hover:bg-teal-700"
                >
                  추가
                </button>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mt-4">
                {data.packingList.map(item => (
                  <div key={item.id} className={`flex items-center justify-between p-3 rounded-lg border cursor-pointer transition-all ${item.checked ? 'bg-gray-100 border-gray-200' : 'bg-white border-teal-100 shadow-sm hover:shadow'}`}
                    onClick={() => toggleCheck('packingList', item.id)}
                  >
                    <div className="flex items-center gap-3 overflow-hidden">
                      <div className={`w-5 h-5 rounded border flex items-center justify-center ${item.checked ? 'bg-teal-500 border-teal-500' : 'border-gray-300'}`}>
                        {item.checked && <CheckSquare size={14} className="text-white" />}
                      </div>
                      <span className={`truncate ${item.checked ? 'text-gray-400 line-through' : 'text-gray-800'}`}>{item.text}</span>
                    </div>
                    <button 
                      onClick={(e) => {
                        e.stopPropagation();
                        deleteItem('packingList', item.id);
                      }}
                      className="text-gray-300 hover:text-red-500 p-1"
                    >
                      <Trash2 size={16} />
                    </button>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* 4. 기념품 목록 */}
          {activeTab === 'souvenir' && (
            <div className="space-y-6">
              <h2 className="text-2xl font-bold text-gray-800 border-b pb-2">🎁 기념품 목록</h2>
              
              <div className="flex gap-2 mb-4 p-4 bg-gray-50 rounded-lg">
                <input id="souvenirItem" placeholder="무엇을?" className="flex-[2] border rounded p-2 text-sm" />
                <input id="souvenirReceiver" placeholder="누구에게?" className="flex-1 border rounded p-2 text-sm" />
                <button 
                  onClick={() => {
                    const item = document.getElementById('souvenirItem');
                    const receiver = document.getElementById('souvenirReceiver');
                    if(item.value && receiver.value) {
                      addItem('souvenirs', { item: item.value, receiver: receiver.value, bought: false });
                      item.value = '';
                      receiver.value = '';
                    }
                  }}
                  className="bg-teal-600 text-white px-4 rounded hover:bg-teal-700 text-sm"
                >
                  추가
                </button>
              </div>

              <div className="overflow-x-auto">
                <table className="w-full text-left border-collapse">
                  <thead>
                    <tr className="bg-teal-50 text-teal-800 border-b border-teal-100">
                      <th className="p-3 w-16 text-center">구매</th>
                      <th className="p-3">상품명</th>
                      <th className="p-3">받는 사람</th>
                      <th className="p-3 w-16 text-center">삭제</th>
                    </tr>
                  </thead>
                  <tbody>
                    {data.souvenirs.map(s => (
                      <tr key={s.id} className="border-b hover:bg-gray-50">
                        <td className="p-3 text-center">
                          <input 
                            type="checkbox" 
                            checked={s.bought} 
                            onChange={() => toggleSouvenir(s.id)}
                            className="w-4 h-4 text-teal-600 rounded focus:ring-teal-500"
                          />
                        </td>
                        <td className={`p-3 ${s.bought ? 'line-through text-gray-400' : ''}`}>{s.item}</td>
                        <td className={`p-3 ${s.bought ? 'text-gray-400' : 'text-gray-600'}`}>{s.receiver}</td>
                        <td className="p-3 text-center">
                          <button onClick={() => deleteItem('souvenirs', s.id)} className="text-gray-300 hover:text-red-500">
                            <Trash2 size={16} />
                          </button>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          )}

          {/* 5. 가계부 */}
          {activeTab === 'expense' && (
            <div className="space-y-6">
              <h2 className="text-2xl font-bold text-gray-800 border-b pb-2">💸 여행 가계부</h2>
              
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div className="bg-gray-50 p-4 rounded-lg border">
                  <p className="text-sm text-gray-500">총 예산</p>
                  <p className="text-xl font-bold text-gray-800">{Number(data.budget).toLocaleString()}원</p>
                </div>
                <div className="bg-red-50 p-4 rounded-lg border border-red-100">
                  <p className="text-sm text-red-500">총 지출</p>
                  <p className="text-xl font-bold text-red-700">{totalExpense.toLocaleString()}원</p>
                </div>
                <div className={`p-4 rounded-lg border ${remainingBudget >= 0 ? 'bg-blue-50 border-blue-100' : 'bg-red-100 border-red-200'}`}>
                  <p className={`text-sm ${remainingBudget >= 0 ? 'text-blue-500' : 'text-red-500'}`}>남은 돈</p>
                  <p className={`text-xl font-bold ${remainingBudget >= 0 ? 'text-blue-700' : 'text-red-700'}`}>{remainingBudget.toLocaleString()}원</p>
                </div>
              </div>

              <div className="flex gap-2 mb-4 flex-wrap">
                 <select id="expenseCat" className="border rounded p-2 text-sm">
                   <option>식비</option>
                   <option>교통</option>
                   <option>숙박</option>
                   <option>쇼핑</option>
                   <option>기타</option>
                 </select>
                <input id="expenseItem" placeholder="내용 (예: 점심)" className="flex-1 border rounded p-2 text-sm min-w-[120px]" />
                <input id="expenseCost" type="number" placeholder="금액" className="w-24 border rounded p-2 text-sm text-right" />
                <button 
                  onClick={() => {
                    const cat = document.getElementById('expenseCat');
                    const item = document.getElementById('expenseItem');
                    const cost = document.getElementById('expenseCost');
                    if(item.value && cost.value) {
                      addItem('expenses', { category: cat.value, item: item.value, cost: parseInt(cost.value) });
                      item.value = '';
                      cost.value = '';
                    }
                  }}
                  className="bg-teal-600 text-white px-4 rounded hover:bg-teal-700 text-sm"
                >
                  추가
                </button>
              </div>

              <div className="overflow-x-auto max-h-[400px] overflow-y-auto">
                <table className="w-full text-left border-collapse text-sm">
                  <thead className="bg-gray-100 sticky top-0">
                    <tr>
                      <th className="p-3 w-20">분류</th>
                      <th className="p-3">내역</th>
                      <th className="p-3 text-right">금액</th>
                      <th className="p-3 w-12 text-center">삭제</th>
                    </tr>
                  </thead>
                  <tbody>
                    {data.expenses.map(e => (
                      <tr key={e.id} className="border-b hover:bg-gray-50">
                        <td className="p-3 text-gray-500">
                          <span className="bg-gray-200 text-xs px-2 py-1 rounded">{e.category}</span>
                        </td>
                        <td className="p-3">{e.item}</td>
                        <td className="p-3 text-right font-medium">{e.cost.toLocaleString()}원</td>
                        <td className="p-3 text-center">
                          <button onClick={() => deleteItem('expenses', e.id)} className="text-gray-300 hover:text-red-500">
                            <Trash2 size={14} />
                          </button>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          )}

        </div>
      </div>
      
      {/* Custom Confirmation Modal (replacing window.confirm) */}
      {showModal && (
        <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
            <h3 className="text-xl font-bold text-gray-800 mb-4">⚠️ 데이터 초기화 확인</h3>
            <p className="text-gray-600 mb-6">현재 저장된 모든 여행 계획 데이터가 삭제되고 초기 상태로 돌아갑니다. 계속하시겠습니까?</p>
            <div className="flex justify-end gap-3">
              <button 
                onClick={cancelReset} 
                className="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition"
              >
                취소
              </button>
              <button 
                onClick={confirmReset} 
                className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition"
              >
                초기화 확인
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
